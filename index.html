<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚®ãƒ•ãƒˆã¾ã‚“ãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
            background: #0a0a0a;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            overflow-y: auto;
            padding: 20px 0;
        }

        #game-container {
            width: 90vw;
            max-width: 480px;
            aspect-ratio: 9/16;
            background: #2c3e50;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
            margin: auto;
        }

        /* å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
        }

        .screen.active {
            display: flex;
        }

        /* ãƒãƒ¼ã‚¿ãƒ«ç”»é¢ */
        #portal-screen {
            background: #00bfff;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
        }

        .game-title {
            font-size: 42px;
            color: #fff;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
            text-align: center;
        }

        .game-subtitle {
            font-size: 16px;
            color: #fff;
            margin-bottom: 50px;
            text-align: center;
            opacity: 0.9;
        }

        .portal-buttons {
            width: 100%;
            max-width: 350px;
        }

        .portal-button {
            width: 100%;
            padding: 18px;
            margin: 12px 0;
            font-size: 20px;
            font-weight: bold;
            background: #ffffff;
            color: #00bfff;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .portal-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .portal-button.primary {
            background: #6778ff;
            color: white;
            font-size: 24px;
            padding: 22px;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠï¼†é…ä¿¡è€…å¤‰æ›´ç”»é¢ */
        #stage-select-screen {
            background: #2c3e50;
            padding: 20px;
            overflow-y: auto;
        }

        .screen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }

        .back-to-portal {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .back-to-portal:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .screen-title {
            color: #fff;
            font-size: 24px;
            font-weight: bold;
        }

        /* é…ä¿¡è€…ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .streamer-section {
            background: #34495e;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .section-label {
            color: #aaa;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .current-streamer {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .streamer-avatar {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background: #00bfff;
        }

        .streamer-avatar.female {
            background: #6778ff;
        }

        .streamer-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .streamer-info {
            flex: 1;
        }

        .streamer-name {
            color: #fff;
            font-size: 20px;
            font-weight: bold;
        }

        .change-streamer-btn {
            background: rgba(0, 191, 255, 0.3);
            border: 2px solid #00bfff;
            color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .change-streamer-btn:hover {
            background: rgba(0, 191, 255, 0.5);
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¸ãƒªã‚¹ãƒˆ */
        .stages-section {
            background: #34495e;
            border-radius: 15px;
            padding: 20px;
        }

        #stage-list {
            margin-top: 15px;
        }

        .stage-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .stage-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #00bfff;
            transform: translateX(5px);
        }

        .stage-item.cleared {
            background: rgba(0, 191, 255, 0.2);
            border-color: #00bfff;
        }

        .stage-item.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .stage-item.locked:hover {
            transform: none;
            border-color: transparent;
        }

        .stage-icon {
            font-size: 36px;
            margin-right: 12px;
        }

        .stage-info {
            flex: 1;
        }

        .stage-name {
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .stage-condition {
            color: #aaa;
            font-size: 12px;
        }

        .stage-status {
            color: #ffd700;
            font-size: 13px;
            font-weight: bold;
        }

        /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠç”»é¢ */
        #character-select-screen {
            background: rgba(0, 0, 0, 0.95);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #character-select-screen h2 {
            color: #fff;
            font-size: 32px;
            margin-bottom: 50px;
            text-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }

        .character-options {
            display: flex;
            gap: 40px;
        }

        .character-option {
            cursor: pointer;
            transition: transform 0.3s;
            text-align: center;
        }

        .character-option:hover {
            transform: scale(1.1);
        }

        .character-box {
            width: 120px;
            height: 120px;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 3px solid #fff;
            transition: all 0.3s;
            margin-bottom: 15px;
            overflow: hidden;
            background: #00bfff;
        }

        .character-box.female {
            background: #6778ff;
        }

        .character-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .character-option:hover .character-box {
            box-shadow: 0 0 30px rgba(255,255,255,0.5);
        }

        .character-name {
            color: #fff;
            font-size: 20px;
            font-weight: bold;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¸ç¢ºèªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ */
        #stage-confirm-screen {
            background: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            z-index: 500;
        }

        .confirm-overlay {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .confirm-window {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .confirm-boss-icon {
            font-size: 80px;
            margin-bottom: 15px;
        }

        .confirm-boss-name {
            font-size: 24px;
            font-weight: bold;
            color: #00bfff;
            margin-bottom: 15px;
        }

        .confirm-boss-quote {
            font-size: 16px;
            color: #333;
            margin-bottom: 25px;
            line-height: 1.6;
            font-style: italic;
        }

        .confirm-divider {
            height: 2px;
            background: linear-gradient(to right, transparent, #00bfff, transparent);
            margin: 20px 0;
        }

        .confirm-condition {
            margin-bottom: 20px;
        }

        .confirm-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .confirm-value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .confirm-difficulty {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .difficulty-tag {
            background: rgba(103, 120, 255, 0.1);
            border: 2px solid #6778ff;
            color: #6778ff;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
        }

        .confirm-start-btn {
            width: 100%;
            padding: 18px;
            font-size: 20px;
            font-weight: bold;
            background: #00bfff;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .confirm-start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 191, 255, 0.4);
        }

        .confirm-back-btn {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            background: transparent;
            color: #666;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .confirm-back-btn:hover {
            color: #333;
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ */
        #game-screen {
            flex-direction: column;
            position: relative;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        #header {
            background: rgba(0, 0, 0, 0.6);
            padding: 12px 15px;
            color: white;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
            backdrop-filter: blur(5px);
        }

        .boss-info {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }

        .boss-icon {
            font-size: 24px;
            margin-right: 8px;
        }

        .boss-name {
            font-size: 18px;
            font-weight: bold;
            flex: 1;
        }

        .stage-number {
            font-size: 12px;
            color: #ffd700;
        }

        .boss-condition {
            font-size: 12px;
            color: #ccc;
            margin-left: 32px;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ - ã‚¢ãƒã‚¿ãƒ¼å…¨é¢è¡¨ç¤º */
        #main-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding: 0;
        }

        #streamer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0;
            margin: 0;
            background: #00bfff;
            z-index: 1;
        }

        #streamer.female {
            background: #6778ff;
        }

        #streamer img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #gift {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            opacity: 0;
            pointer-events: none;
            animation: none;
            z-index: 5;
        }

        #gift img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.8));
        }

        @keyframes popup {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            10% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            20% { transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }

        .gift-active {
            animation: popup 1s ease-out;
        }

        /* ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³ - ãƒ¢ãƒã‚¯ãƒ­ï¼‹é€é */
        #shutter-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            border: 4px solid rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
            overflow: hidden;
            z-index: 15;
            position: relative;
            margin-bottom: 200px;
            backdrop-filter: blur(5px);
        }

        #shutter-button img {
            width: 50%;
            height: 50%;
            object-fit: contain;
            filter: brightness(0) invert(1);
            opacity: 0.9;
        }

        #shutter-button:active {
            transform: scale(0.9);
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
            background: rgba(255, 255, 255, 0.5);
        }

        /* ã‚¹ã‚³ã‚¢è¡¨ç¤º */
        #score-display {
            position: absolute;
            top: 70px;
            right: 15px;
            color: white;
            text-align: right;
            font-size: 13px;
            background: rgba(0,0,0,0.4);
            padding: 8px 12px;
            border-radius: 8px;
            z-index: 10;
            backdrop-filter: blur(5px);
        }

        .score-item {
            margin: 4px 0;
        }

        .score-label {
            color: #ddd;
            font-size: 11px;
        }

        .score-value {
            font-weight: bold;
            font-size: 16px;
            color: #ffd700;
        }

        #judgment {
            position: absolute;
            top: 35%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            font-weight: bold;
            opacity: 0;
            pointer-events: none;
            z-index: 20;
            background: white;
            color: #00bfff;
            padding: 15px 30px;
            border-radius: 12px;
            border: 3px solid #00bfff;
        }

        .judgment-perfect {
            animation: judgment-anim 1s ease-out;
        }

        .judgment-good {
            animation: judgment-anim 1s ease-out;
        }

        .judgment-miss {
            color: #ff6b6b;
            border-color: #ff6b6b;
            animation: judgment-anim 1s ease-out;
        }

        .judgment-hazure {
            color: #ff6b6b;
            border-color: #ff6b6b;
            animation: judgment-anim 1s ease-out;
        }

        @keyframes judgment-anim {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }

        /* ã‚³ãƒ¡ãƒ³ãƒˆã‚¨ãƒªã‚¢ - åŠé€æ˜ç™½èƒŒæ™¯ */
        #comment-area {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 180px;
            background: rgba(255, 255, 255, 0.85);
            padding: 15px;
            overflow: hidden;
            z-index: 10;
            backdrop-filter: blur(10px);
        }

        #comments {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 0 15px 15px;
        }

        .comment {
            color: #1a1a1a;
            padding: 8px 12px;
            margin: 6px 0;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            font-size: 14px;
            opacity: 0;
            transform: translateY(20px);
            animation: comment-in 0.3s ease-out forwards;
            font-weight: 500;
        }

        @keyframes comment-in {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ã‚¯ãƒªã‚¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #clear-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .clear-message {
            font-size: 50px;
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 30px;
            text-shadow: 0 4px 8px rgba(0,0,0,0.5);
            animation: clear-pulse 1s ease-in-out infinite;
        }

        @keyframes clear-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .block-message {
            font-size: 35px;
            color: #03ffff;
            font-weight: bold;
            margin-bottom: 20px;
            padding: 15px 30px;
            background: rgba(3, 255, 255, 0.2);
            border: 3px solid #03ffff;
            border-radius: 15px;
        }

        .next-button {
            margin-top: 10px;
            padding: 15px 40px;
            font-size: 20px;
            background: #00bfff;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .next-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(0, 191, 255, 0.5);
        }

        .next-button.secondary {
            background: #6778ff;
        }

        #gameover-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .gameover-message {
            font-size: 50px;
            color: #6778ff;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }

        .gameover-subtitle {
            font-size: 30px;
            color: #fff;
            margin-bottom: 30px;
        }

        #game-complete {
            background: #00bfff;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }

        .complete-title {
            font-size: 45px;
            color: #fff;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .complete-subtitle {
            font-size: 24px;
            color: #fff;
            margin-bottom: 40px;
        }

        .restart-button {
            padding: 20px 50px;
            font-size: 24px;
            background: white;
            color: #00bfff;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .restart-button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 40px rgba(255,255,255,0.8);
        }

        /* æƒ…å ±ç”»é¢ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .info-screen {
            padding: 30px 20px;
            overflow-y: auto;
        }

        .info-content {
            color: #fff;
            line-height: 1.8;
        }

        .info-content h3 {
            font-size: 24px;
            margin: 25px 0 15px;
            color: #03ffff;
        }

        .info-content p {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- ãƒãƒ¼ã‚¿ãƒ«ç”»é¢ -->
        <div id="portal-screen" class="screen active">
            <div class="game-title">ã‚®ãƒ•ãƒˆã¾ã‚“ãƒãƒ£ãƒ¬ãƒ³ã‚¸</div>
            <div class="game-subtitle">åå°„ç¥çµŒã§ãƒœã‚¹ã‚’æ’ƒç ´ã›ã‚ˆï¼</div>
            <div class="portal-buttons">
                <button class="portal-button primary" onclick="startGame()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
                <button class="portal-button" onclick="showScreen('story-screen')">ã‚¹ãƒˆãƒ¼ãƒªãƒ¼</button>
                <button class="portal-button" onclick="showScreen('howto-screen')">éŠã³æ–¹</button>
                <button class="portal-button" onclick="showScreen('ranking-screen')">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
                <button class="portal-button" onclick="showScreen('news-screen')">ãŠçŸ¥ã‚‰ã›</button>
            </div>
        </div>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠï¼†é…ä¿¡è€…å¤‰æ›´ç”»é¢ -->
        <div id="stage-select-screen" class="screen">
            <div class="screen-header">
                <button class="back-to-portal" onclick="showScreen('portal-screen')">æˆ»ã‚‹</button>
                <div class="screen-title">ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠ</div>
                <div style="width: 60px;"></div>
            </div>

            <div class="streamer-section">
                <div class="section-label">é…ä¿¡è€…</div>
                <div class="current-streamer">
                    <div class="streamer-avatar" id="current-avatar">
                        <img src="images/character01_1.png" alt="é…ä¿¡è€…">
                    </div>
                    <div class="streamer-info">
                        <div class="streamer-name" id="current-name">Aã•ã‚“</div>
                    </div>
                    <button class="change-streamer-btn" onclick="showScreen('character-select-screen')">å¤‰æ›´</button>
                </div>
            </div>

            <div class="stages-section">
                <div class="section-label">ã‚¹ãƒ†ãƒ¼ã‚¸</div>
                <div id="stage-list"></div>
            </div>
        </div>

        <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠç”»é¢ -->
        <div id="character-select-screen" class="screen">
            <h2>é…ä¿¡è€…ã‚’é¸ã¼ã†</h2>
            <div class="character-options">
                <div class="character-option" onclick="selectCharacter('male', 'Aã•ã‚“')">
                    <div class="character-box">
                        <img src="images/character01_1.png" alt="Aã•ã‚“">
                    </div>
                    <div class="character-name">Aã•ã‚“</div>
                </div>
                <div class="character-option" onclick="selectCharacter('female', 'Bã•ã‚“')">
                    <div class="character-box female">
                        <img src="images/character02_1.png" alt="Bã•ã‚“">
                    </div>
                    <div class="character-name">Bã•ã‚“</div>
                </div>
            </div>
        </div>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¸ç¢ºèªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ -->
        <div id="stage-confirm-screen" class="screen">
            <div class="confirm-overlay">
                <div class="confirm-window">
                    <div class="confirm-boss-icon" id="confirm-boss-icon">ğŸ‘¶</div>
                    <div class="confirm-boss-name" id="confirm-boss-name">ã‚­ãƒƒã‚ºã‚³ãƒ¡ãƒ³ãƒˆ</div>
                    <div class="confirm-boss-quote" id="confirm-boss-quote">ã€Œã­ã‡ã­ã‡ã€èã„ã¦èã„ã¦ï½ï¼ã€</div>
                    
                    <div class="confirm-divider"></div>
                    
                    <div class="confirm-condition">
                        <div class="confirm-label">é”æˆæ¡ä»¶</div>
                        <div class="confirm-value" id="confirm-condition-text">5æšä¸­3æšæˆåŠŸ</div>
                    </div>
                    
                    <div class="confirm-difficulty" id="confirm-difficulty">
                        <div class="difficulty-tag">å‡ºç¾ä½ç½®ãƒ©ãƒ³ãƒ€ãƒ </div>
                        <div class="difficulty-tag">ãƒã‚ºãƒ¬ã‚®ãƒ•ãƒˆã‚ã‚Š</div>
                    </div>
                    
                    <button class="confirm-start-btn" onclick="startGameFromConfirm()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                    <button class="confirm-back-btn" onclick="backToStageSelectFromConfirm()">æˆ»ã‚‹</button>
                </div>
            </div>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div id="game-screen" class="screen">
            <div id="header">
                <div class="boss-info">
                    <span class="boss-icon" id="boss-icon">ğŸ‘¶</span>
                    <span class="boss-name" id="boss-name">ã‚­ãƒƒã‚ºã‚³ãƒ¡ãƒ³ãƒˆ</span>
                    <span class="stage-number" id="stage-number">STAGE 1/12</span>
                </div>
                <div class="boss-condition" id="boss-condition">æ¡ä»¶: 5æšä¸­3æšæˆåŠŸ</div>
            </div>

            <div id="main-area">
                <div id="score-display">
                    <div class="score-item">
                        <span class="score-label">ã‚·ãƒ£ãƒƒã‚¿ãƒ¼:</span>
                        <span class="score-value" id="shutter-count">5</span>
                    </div>
                    <div class="score-item">
                        <span class="score-label">æˆåŠŸ:</span>
                        <span class="score-value" id="success-count">0/3</span>
                    </div>
                    <div class="score-item">
                        <span class="score-value" id="perfect-count">PERFECT: 0</span>
                    </div>
                </div>

                <div id="streamer">
                    <img id="streamer-image" src="images/character01_1.png" alt="é…ä¿¡è€…">
                </div>

                <div id="gift">
                    <img src="images/gift01.png" alt="ã‚®ãƒ•ãƒˆ">
                </div>
                <div id="judgment"></div>

                <button id="shutter-button" onclick="takeShot()">
                    <img src="images/shutter.png" alt="ã‚·ãƒ£ãƒƒã‚¿ãƒ¼">
                </button>
            </div>

            <div id="comment-area">
                <div id="comments"></div>
            </div>

            <div id="clear-overlay">
                <div class="clear-message">STAGE CLEAR!</div>
                <div class="block-message">ãƒãƒ£ãƒ¬ãƒ³ã‚¸æˆåŠŸï¼</div>
                <button class="next-button" onclick="nextStage()">æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸</button>
                <button class="next-button secondary" onclick="backToStageSelect()">ã‚¹ãƒ†ãƒ¼ã‚¸ä¸€è¦§ã¸</button>
            </div>

            <div id="gameover-overlay">
                <div class="gameover-message">GAME OVER</div>
                <div class="gameover-subtitle">å¤±æ•—...</div>
                <button class="next-button" onclick="retryStage()">ãƒªãƒˆãƒ©ã‚¤</button>
                <button class="next-button secondary" onclick="backToStageSelect()">ã‚¹ãƒ†ãƒ¼ã‚¸ä¸€è¦§ã¸</button>
            </div>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ç”»é¢ -->
        <div id="game-complete" class="screen">
            <div class="complete-title">GAME COMPLETE!</div>
            <div class="complete-subtitle">å¹³å’Œãªé…ä¿¡ç©ºé–“ã‚’å–ã‚Šæˆ»ã—ãŸï¼</div>
            <button class="restart-button" onclick="showScreen('portal-screen')">ãƒãƒ¼ã‚¿ãƒ«ã¸æˆ»ã‚‹</button>
        </div>

        <!-- ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç”»é¢ -->
        <div id="story-screen" class="screen info-screen">
            <div class="screen-header">
                <button class="back-to-portal" onclick="showScreen('portal-screen')">æˆ»ã‚‹</button>
                <div class="screen-title">ã‚¹ãƒˆãƒ¼ãƒªãƒ¼</div>
                <div style="width: 60px;"></div>
            </div>
            <div class="info-content">
                <p>ã‚ã‚‹æ—¥ã€å¹³å’Œã ã£ãŸé…ä¿¡ç©ºé–“ã«ç¾ã‚ŒãŸå„ä»‹ãªå­˜åœ¨ãŸã¡...</p>
                <p>ã‚­ãƒƒã‚ºã‚³ãƒ¡ãƒ³ãƒˆã€è’ã‚‰ã—ã€ã‚»ã‚¯ãƒãƒ©ã€è‡ªèªã€ãã—ã¦æœ€å‡¶ã®ã€Œæ°—æŒè¡¨æ˜ç²˜ç€åè»¢ã€ã¾ã§ã€‚</p>
                <p>é…ä¿¡è€…ã¨ã—ã¦ã€å›ã¯ã€Œã‚®ãƒ•ãƒˆã¾ã‚“ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã€ã®æŠ€è¡“ã‚’ä½¿ã£ã¦ã€ã“ã‚Œã‚‰ã®å„ä»‹è€…ãŸã¡ã‚’æ’ƒé€€ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ï¼</p>
                <p>ä¸€ç¬ã§æ¶ˆãˆã‚‹ã‚®ãƒ•ãƒˆã¾ã‚“ã‚’å®Œç’§ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§æ’®å½±ã—ã€ãƒœã‚¹ãŸã¡ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã‚„ã‚Œï¼</p>
            </div>
        </div>

        <!-- éŠã³æ–¹ç”»é¢ -->
        <div id="howto-screen" class="screen info-screen">
            <div class="screen-header">
                <button class="back-to-portal" onclick="showScreen('portal-screen')">æˆ»ã‚‹</button>
                <div class="screen-title">éŠã³æ–¹</div>
                <div style="width: 60px;"></div>
            </div>
            <div class="info-content">
                <h3>åŸºæœ¬ãƒ«ãƒ¼ãƒ«</h3>
                <p>ç”»é¢ã«å‡ºç¾ã™ã‚‹ã‚®ãƒ•ãƒˆã¾ã‚“ã‚’ã€ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã§ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚ˆãæ’®å½±ã—ã‚ˆã†ï¼</p>
                
                <h3>åˆ¤å®š</h3>
                <p><strong>PERFECT:</strong> æœ€é«˜ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼</p>
                <p><strong>GOOD:</strong> æˆåŠŸï¼</p>
                <p><strong>MISS:</strong> å¤±æ•—...</p>
                
                <h3>ã‚¯ãƒªã‚¢æ¡ä»¶</h3>
                <p>å„ã‚¹ãƒ†ãƒ¼ã‚¸ã§è¨­å®šã•ã‚ŒãŸæ¡ä»¶ã‚’æº€ãŸã™ã¨ã‚¯ãƒªã‚¢ï¼</p>
                <p>å¾ŒåŠã®ã‚¹ãƒ†ãƒ¼ã‚¸ã§ã¯PERFECTãŒå¿…è¦ã«ãªã‚‹ã‚ˆã€‚</p>
            </div>
        </div>

        <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ -->
        <div id="ranking-screen" class="screen info-screen">
            <div class="screen-header">
                <button class="back-to-portal" onclick="showScreen('portal-screen')">æˆ»ã‚‹</button>
                <div class="screen-title">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
                <div style="width: 60px;"></div>
            </div>
            <div class="info-content">
                <p style="text-align: center; padding: 40px 0;">æº–å‚™ä¸­</p>
                <p style="text-align: center;">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ã¯å¾Œæ—¥å®Ÿè£…äºˆå®šã§ã™ï¼</p>
            </div>
        </div>

        <!-- ãŠçŸ¥ã‚‰ã›ç”»é¢ -->
        <div id="news-screen" class="screen info-screen">
            <div class="screen-header">
                <button class="back-to-portal" onclick="showScreen('portal-screen')">æˆ»ã‚‹</button>
                <div class="screen-title">ãŠçŸ¥ã‚‰ã›</div>
                <div style="width: 60px;"></div>
            </div>
            <div class="info-content">
                <h3>Ver 1.0 ãƒªãƒªãƒ¼ã‚¹</h3>
                <p>ã‚®ãƒ•ãƒˆã¾ã‚“ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã€æ­£å¼ãƒªãƒªãƒ¼ã‚¹ï¼</p>
                <p>å…¨12ã‚¹ãƒ†ãƒ¼ã‚¸ã§é…ä¿¡è€…ã‚’å®ˆã‚ŠæŠœã“ã†ï¼</p>
            </div>
        </div>
    </div>

    <script>
        const BOSSES = [
            {
                name: 'ã‚­ãƒƒã‚ºã‚³ãƒ¡ãƒ³ãƒˆ',
                icon: 'ğŸ‘¶',
                quote: 'ã­ã‡ã­ã‡ã€èã„ã¦èã„ã¦ï½ï¼',
                displayTime: 600,
                shutterCount: 5,
                requiredSuccess: 3,
                requiredPerfect: 0,
                hasDecoy: false,
                randomPosition: false,
                comments: ['ã­ã‡ã­ã‡', 'ã‚ã®ã•ãƒ¼', 'ã€‡ã€‡ã£ã¦çŸ¥ã£ã¦ã‚‹ï¼Ÿ', 'è³ªå•ã„ã„ï¼Ÿ', 'ã­ã‡èã„ã¦ã‚‹ï¼Ÿ']
            },
            {
                name: 'è’ã—ã‚³ãƒ¡ãƒ³ãƒˆ',
                icon: 'ğŸ˜ˆ',
                quote: 'ã¤ã¾ã‚“ã­ãƒ¼ãªã€ã‚‚ã£ã¨é¢ç™½ã„ã“ã¨ã‚„ã‚Œã‚ˆ',
                displayTime: 550,
                shutterCount: 5,
                requiredSuccess: 3,
                requiredPerfect: 0,
                hasDecoy: false,
                randomPosition: false,
                comments: ['ã¤ã¾ã‚“ãª', 'ã‚‚ã†çµ‚ã‚ã‚Šï¼Ÿ', 'ä¸‹æ‰‹ãã', 'ã‚»ãƒ³ã‚¹ãªã„ã­', 'ä»–ã®è¦‹ã‚‹ã‚']
            },
            {
                name: 'ã‚»ã‚¯ãƒãƒ©ã‚³ãƒ¡ãƒ³ãƒˆ',
                icon: 'ğŸ˜',
                quote: 'å¯æ„›ã™ãâ™¡ å½¼æ°ã„ã‚‹ï¼Ÿ',
                displayTime: 500,
                shutterCount: 5,
                requiredSuccess: 3,
                requiredPerfect: 1,
                hasDecoy: false,
                randomPosition: false,
                comments: ['å¯æ„›ã™ã', 'å½¼æ°ã„ã‚‹ï¼Ÿ', 'ä¼šã„ãŸã„ãª', 'LINEæ•™ãˆã¦', 'ä¿ºã®ã“ã¨ã©ã†æ€ã†ï¼Ÿ']
            },
            {
                name: 'è‡ªèª',
                icon: 'ğŸ—£ï¸',
                quote: 'ä¿ºã•ãƒ¼ã€ä»Šæ—¥ã­ã€ãƒã‚¸ã§ã•ãƒ¼',
                displayTime: 450,
                shutterCount: 5,
                requiredSuccess: 3,
                requiredPerfect: 2,
                hasDecoy: false,
                randomPosition: true,
                comments: ['ä¿ºã•ãƒ¼ã€ä»Šæ—¥ã­', 'èã„ã¦ã‚‹ï¼Ÿä¿ºã®è©±', 'è‡ªåˆ†ã®è©±ã—ã¦ã„ã„ï¼Ÿ', 'ä¿ºã‚‚é…ä¿¡ã—ã¦ã¦', 'ã¡ãªã¿ã«ä¿ºã¯']
            },
            {
                name: 'åˆè¦‹ã§è‡ªåˆ†å®£ä¼',
                icon: 'ğŸ“¢',
                quote: 'ä¿ºã‚‚é…ä¿¡è€…ã§ã™ï¼ãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²ãŠé¡˜ã„ã—ã¾ã™ï¼',
                displayTime: 450,
                shutterCount: 5,
                requiredSuccess: 4,
                requiredPerfect: 2,
                hasDecoy: false,
                randomPosition: true,
                comments: ['ä¿ºã‚‚é…ä¿¡è€…ã§ã™', 'ãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²ãŠé¡˜ã„', 'ä¿ºã®é…ä¿¡ã‚‚æ¥ã¦', 'ã‚³ãƒ©ãƒœã—ã¾ã›ã‚“ã‹', 'ç›¸äº’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¾ã—ã‚‡']
            },
            {
                name: 'æŒ‡ç¤ºå¨',
                icon: 'ğŸ‘†',
                quote: 'ã€‡ã€‡ã‚„ã£ã¦ï¼ãªã‚“ã§ã‚„ã‚‰ãªã„ã®ï¼Ÿ',
                displayTime: 400,
                shutterCount: 5,
                requiredSuccess: 4,
                requiredPerfect: 2,
                hasDecoy: false,
                randomPosition: true,
                comments: ['ã€‡ã€‡ã‚„ã£ã¦', 'æ¬¡ã“ã‚Œã‚„ã‚Œ', 'ãªã‚“ã§ã‚„ã‚‰ãªã„ã®', 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆèã„ã¦ã‚ˆ', 'ãã‚Œé•ã†ã‚ˆ']
            },
            {
                name: 'è£DMé€£æ‰“',
                icon: 'ğŸ“±',
                quote: 'DMè¿”ä¿¡ã—ã¦ï¼æ—¢èª­ã¤ã„ã¦ã‚‹ã‚ˆã­ï¼Ÿ',
                displayTime: 400,
                shutterCount: 5,
                requiredSuccess: 4,
                requiredPerfect: 3,
                hasDecoy: true,
                randomPosition: true,
                comments: ['DMè¿”ä¿¡ã—ã¦', 'ãªã‚“ã§ç„¡è¦–ã™ã‚‹ã®', 'æ—¢èª­ã¤ã„ã¦ã‚‹ã‚ˆã­', 'èª­ã‚“ã§ã‚‹ã§ã—ã‚‡', 'ã­ã‡è¦‹ã¦']
            },
            {
                name: 'è¡ŒãéããŸã‚¬ãƒæ‹',
                icon: 'ğŸ’•',
                quote: 'å¥½ãã§ã™ã€ä»˜ãåˆã£ã¦ãã ã•ã„ï¼',
                displayTime: 350,
                shutterCount: 5,
                requiredSuccess: 4,
                requiredPerfect: 3,
                hasDecoy: true,
                randomPosition: true,
                comments: ['å¥½ãã§ã™ä»˜ãåˆã£ã¦', 'ä¿ºã ã‘è¦‹ã¦', 'ä»–ã®äººã¨è©±ã•ãªã„ã§', 'çµå©šã—ã‚ˆã†', 'é‹å‘½æ„Ÿã˜ã‚‹']
            },
            {
                name: 'ç‰¹å®šå¨',
                icon: 'ğŸ”',
                quote: 'ã€‡ã€‡é§…ã ã‚ˆã­ï¼Ÿæœ¬åçŸ¥ã£ã¦ã‚‹ã‚ˆ',
                displayTime: 350,
                shutterCount: 5,
                requiredSuccess: 4,
                requiredPerfect: 4,
                hasDecoy: true,
                randomPosition: true,
                comments: ['ã€‡ã€‡é§…ã ã‚ˆã­', 'å‰ã«è¦‹ãŸã“ã¨ã‚ã‚‹', 'æœ¬åçŸ¥ã£ã¦ã‚‹ã‚ˆ', 'å­¦æ ¡ã©ã“ï¼Ÿ', 'ä½ã‚“ã§ã‚‹å ´æ‰€ãƒãƒ¬ã¦ã‚‹']
            },
            {
                name: 'ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ³',
                icon: 'ğŸ¦„',
                quote: 'ç”·ã¨å–‹ã‚‹ãªï¼è£åˆ‡ã‚‰ã‚ŒãŸï¼',
                displayTime: 330,
                shutterCount: 5,
                requiredSuccess: 5,
                requiredPerfect: 4,
                hasDecoy: true,
                randomPosition: true,
                comments: ['ç”·ã¨å–‹ã‚‹ãª', 'è£åˆ‡ã‚‰ã‚ŒãŸ', 'æ¸…æ¥šãªã®ãŒè‰¯ã‹ã£ãŸã®ã«', 'ã‚‚ã†è¦‹ãªã„', 'ãƒ•ã‚¡ãƒ³è¾ã‚ã¾ã™']
            },
            {
                name: 'ç„¡æ–­è»¢è¼‰',
                icon: 'ğŸ´â€â˜ ï¸',
                quote: 'ã“ã‚Œä¿å­˜ã—ãŸã€å‹æ‰‹ã«ä½¿ã†ã‚',
                displayTime: 320,
                shutterCount: 5,
                requiredSuccess: 5,
                requiredPerfect: 4,
                hasDecoy: true,
                randomPosition: true,
                comments: ['ã“ã‚Œä¿å­˜ã—ãŸ', 'åˆ¥ã®ã‚µã‚¤ãƒˆã«ä¸Šã’ã‚‹ã­', 'å‹æ‰‹ã«ä½¿ã†ã‚', 'ã‚¹ã‚¯ã‚·ãƒ§æ’®ã£ãŸ', 'è»¢è¼‰ç¦æ­¢ã£ã¦æ›¸ã„ã¦ãªã„ã—']
            },
            {
                name: 'æ°—æŒè¡¨æ˜ç²˜ç€åè»¢',
                icon: 'ğŸ˜¡',
                quote: 'ã„ã¤ã‚‚å¿œæ´ã—ã¦ã¾ã—ãŸã€ãªã®ã«è£åˆ‡ã‚‰ã‚ŒãŸ',
                displayTime: 300,
                shutterCount: 5,
                requiredSuccess: 5,
                requiredPerfect: 5,
                hasDecoy: true,
                randomPosition: true,
                comments: ['ã„ã¤ã‚‚å¿œæ´ã—ã¦ã¾ã—ãŸ', 'ãªã®ã«è£åˆ‡ã‚‰ã‚ŒãŸ', 'ä¿¡ã˜ã¦ãŸã®ã«', 'å¥½ãã ã£ãŸã®ã«å«Œã„ã«ãªã£ãŸ', 'è¨±ã•ãªã„']
            }
        ];

        let gameState = {
            selectedCharacter: localStorage.getItem('selectedCharacter') || null,
            selectedName: localStorage.getItem('selectedName') || null,
            currentStage: 0,
            successCount: 0,
            perfectCount: 0,
            shutterRemaining: 0,
            giftActive: false,
            giftStartTime: 0,
            giftIsDecoy: false,
            gameRunning: false,
            clearedStages: JSON.parse(localStorage.getItem('clearedStages') || '[]'),
            unlockedStage: parseInt(localStorage.getItem('unlockedStage') || '0'),
            giftTimer: null,
            hideGiftTimer: null,
            giftPatterns: [], // äº‹å‰ç”Ÿæˆã•ã‚ŒãŸã‚®ãƒ•ãƒˆå‡ºç¾ãƒ‘ã‚¿ãƒ¼ãƒ³
            currentGiftIndex: 0 // ç¾åœ¨ã®ã‚®ãƒ•ãƒˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        };

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function startGame() {
            if (!gameState.selectedCharacter) {
                showScreen('character-select-screen');
            } else {
                updateCurrentStreamerDisplay();
                renderStageList();
                showScreen('stage-select-screen');
            }
        }

        function selectCharacter(type, name) {
            gameState.selectedCharacter = type;
            gameState.selectedName = name;
            localStorage.setItem('selectedCharacter', type);
            localStorage.setItem('selectedName', name);
            
            updateCurrentStreamerDisplay();
            
            if (gameState.unlockedStage === 0) {
                gameState.currentStage = 0;
                showScreen('game-screen');
                startStage();
            } else {
                renderStageList();
                showScreen('stage-select-screen');
            }
        }

        function updateCurrentStreamerDisplay() {
            const avatar = document.getElementById('current-avatar');
            const nameEl = document.getElementById('current-name');
            
            if (gameState.selectedCharacter === 'female') {
                avatar.classList.add('female');
            } else {
                avatar.classList.remove('female');
            }
            
            const imgSrc = gameState.selectedCharacter === 'male' 
                ? 'images/character01_1.png' 
                : 'images/character02_1.png';
            avatar.querySelector('img').src = imgSrc;
            nameEl.textContent = gameState.selectedName;
        }

        function renderStageList() {
            const stageList = document.getElementById('stage-list');
            stageList.innerHTML = '';
            
            BOSSES.forEach((boss, index) => {
                const stageItem = document.createElement('div');
                stageItem.className = 'stage-item';
                
                const isCleared = gameState.clearedStages.includes(index);
                const isUnlocked = index <= gameState.unlockedStage;
                
                if (isCleared) {
                    stageItem.classList.add('cleared');
                } else if (!isUnlocked) {
                    stageItem.classList.add('locked');
                }
                
                let conditionText = `${boss.requiredSuccess}æšæˆåŠŸ`;
                if (boss.requiredPerfect > 0) {
                    conditionText += ` (PERFECT ${boss.requiredPerfect})`;
                }
                
                let statusText = '';
                if (isCleared) {
                    statusText = 'ã‚¯ãƒªã‚¢æ¸ˆã¿';
                } else if (isUnlocked) {
                    statusText = 'æŒ‘æˆ¦å¯èƒ½';
                } else {
                    statusText = 'æœªé–‹æ”¾';
                }
                
                stageItem.innerHTML = `
                    <div class="stage-icon">${boss.icon}</div>
                    <div class="stage-info">
                        <div class="stage-name">STAGE ${index + 1}: ${boss.name}</div>
                        <div class="stage-condition">${conditionText}</div>
                    </div>
                    <div class="stage-status">${statusText}</div>
                `;
                
                if (isUnlocked) {
                    stageItem.onclick = () => {
                        gameState.currentStage = index;
                        showStageConfirm();
                    };
                }
                
                stageList.appendChild(stageItem);
            });
        }

        function showStageConfirm() {
            const boss = BOSSES[gameState.currentStage];
            
            // ãƒœã‚¹æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('confirm-boss-icon').textContent = boss.icon;
            document.getElementById('confirm-boss-name').textContent = boss.name;
            document.getElementById('confirm-boss-quote').textContent = `ã€Œ${boss.quote}ã€`;
            
            // é”æˆæ¡ä»¶ã‚’è¡¨ç¤º
            let conditionText = `${boss.requiredSuccess}æšæˆåŠŸ`;
            if (boss.requiredPerfect > 0) {
                conditionText += ` (PERFECT ${boss.requiredPerfect}å›)`;
            }
            document.getElementById('confirm-condition-text').textContent = conditionText;
            
            // é›£æ˜“åº¦ã‚¿ã‚°ã‚’è¡¨ç¤º
            const difficultyDiv = document.getElementById('confirm-difficulty');
            difficultyDiv.innerHTML = '';
            
            if (boss.randomPosition) {
                const tag = document.createElement('div');
                tag.className = 'difficulty-tag';
                tag.textContent = 'å‡ºç¾ä½ç½®ãƒ©ãƒ³ãƒ€ãƒ ';
                difficultyDiv.appendChild(tag);
            }
            
            if (boss.hasDecoy) {
                const tag = document.createElement('div');
                tag.className = 'difficulty-tag';
                tag.textContent = 'ãƒã‚ºãƒ¬ã‚®ãƒ•ãƒˆã‚ã‚Š';
                difficultyDiv.appendChild(tag);
            }
            
            showScreen('stage-confirm-screen');
        }

        function backToStageSelectFromConfirm() {
            showScreen('stage-select-screen');
        }

        function startGameFromConfirm() {
            // ã‚®ãƒ•ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç”Ÿæˆ
            generateGiftPatterns();
            
            // ã‚²ãƒ¼ãƒ ç”»é¢ã¸ç§»è¡Œ
            showScreen('game-screen');
            startStage();
        }

        function generateGiftPatterns() {
            const boss = BOSSES[gameState.currentStage];
            gameState.giftPatterns = [];
            
            // ã‚®ãƒ•ãƒˆã®å‡ºç¾å›æ•°ã‚’æ±ºå®šï¼ˆã‚·ãƒ£ãƒƒã‚¿ãƒ¼å›æ•° + æ•°å€‹ä½™åˆ†ã«ï¼‰
            const giftCount = boss.shutterCount + 3;
            
            console.log('Generating', giftCount, 'gift patterns for stage', gameState.currentStage + 1);
            
            for (let i = 0; i < giftCount; i++) {
                const pattern = {
                    delay: 2000 + Math.random() * 2000, // 2000-4000ms
                    isDecoy: boss.hasDecoy && Math.random() < 0.3,
                    position: boss.randomPosition ? {
                        x: 30 + Math.random() * 40,
                        y: 25 + Math.random() * 30
                    } : { x: 50, y: 40 }
                };
                gameState.giftPatterns.push(pattern);
            }
            
            gameState.currentGiftIndex = 0;
            console.log('Generated patterns:', gameState.giftPatterns);
        }

        function startStage() {
            const boss = BOSSES[gameState.currentStage];
            
            // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            if (gameState.giftTimer) {
                clearTimeout(gameState.giftTimer);
                gameState.giftTimer = null;
            }
            if (gameState.hideGiftTimer) {
                clearTimeout(gameState.hideGiftTimer);
                gameState.hideGiftTimer = null;
            }
            
            gameState.successCount = 0;
            gameState.perfectCount = 0;
            gameState.shutterRemaining = boss.shutterCount;
            gameState.giftActive = false;
            gameState.gameRunning = true;
            
            document.getElementById('boss-icon').textContent = boss.icon;
            document.getElementById('boss-name').textContent = boss.name;
            document.getElementById('stage-number').textContent = `STAGE ${gameState.currentStage + 1}/12`;
            
            let conditionText = `${boss.requiredSuccess}æšæˆåŠŸ`;
            if (boss.requiredPerfect > 0) {
                conditionText += ` | PERFECT ${boss.requiredPerfect}å›`;
            }
            document.getElementById('boss-condition').textContent = conditionText;
            
            const streamer = document.getElementById('streamer');
            if (gameState.selectedCharacter === 'female') {
                streamer.classList.add('female');
            } else {
                streamer.classList.remove('female');
            }
            
            updateScoreDisplay();
            updateFace();
            startCommentFlow();
            scheduleNextGift();
        }

        function updateScoreDisplay() {
            const boss = BOSSES[gameState.currentStage];
            document.getElementById('success-count').textContent = 
                `${gameState.successCount}/${boss.requiredSuccess}`;
            document.getElementById('perfect-count').textContent = 
                `PERFECT: ${gameState.perfectCount}`;
            document.getElementById('shutter-count').textContent = gameState.shutterRemaining;
        }

        function updateFace() {
            const boss = BOSSES[gameState.currentStage];
            const streamerImg = document.getElementById('streamer-image');
            
            const neededSuccess = boss.requiredSuccess - gameState.successCount;
            const neededPerfect = Math.max(0, boss.requiredPerfect - gameState.perfectCount);
            
            const charPrefix = gameState.selectedCharacter === 'male' ? 'character01' : 'character02';
            
            if (gameState.successCount >= boss.requiredSuccess && 
                gameState.perfectCount >= boss.requiredPerfect) {
                streamerImg.src = `images/${charPrefix}_3.png`; // å¾—æ„é¡”
            }
            else if (gameState.shutterRemaining < neededSuccess || 
                     gameState.shutterRemaining < neededPerfect ||
                     (neededSuccess === 1 && gameState.shutterRemaining === 1) ||
                     (neededPerfect === 1 && gameState.shutterRemaining === 1)) {
                streamerImg.src = `images/${charPrefix}_2.png`; // ç„¦ã‚Š
            }
            else {
                streamerImg.src = `images/${charPrefix}_1.png`; // é€šå¸¸
            }
        }

        function scheduleNextGift() {
            if (!gameState.gameRunning) {
                console.log('Game not running, cannot schedule gift');
                return;
            }
            
            // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            if (gameState.giftTimer) {
                clearTimeout(gameState.giftTimer);
                gameState.giftTimer = null;
            }
            
            // ã‚·ãƒ£ãƒƒã‚¿ãƒ¼æ®‹æ•°ãŒãªããªã£ãŸã‚‰ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®š
            if (gameState.shutterRemaining <= 0) {
                console.log('No shutter remaining, checking game over');
                setTimeout(() => {
                    checkGameResult();
                }, 1000);
                return;
            }
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ®‹ã£ã¦ã„ãªã„å ´åˆã¯çµ‚äº†
            if (gameState.currentGiftIndex >= gameState.giftPatterns.length) {
                console.log('No more gift patterns');
                return;
            }
            
            const pattern = gameState.giftPatterns[gameState.currentGiftIndex];
            gameState.currentGiftIndex++;
            
            console.log('Scheduling next gift in', pattern.delay, 'ms. Pattern index:', gameState.currentGiftIndex - 1);
            
            gameState.giftTimer = setTimeout(() => {
                showGift();
            }, pattern.delay);
        }

        function showGift() {
            if (!gameState.gameRunning) {
                console.log('Game not running, cannot show gift');
                return;
            }
            
            const boss = BOSSES[gameState.currentStage];
            const pattern = gameState.giftPatterns[gameState.currentGiftIndex - 1];
            
            if (!pattern) {
                console.log('No pattern found for index:', gameState.currentGiftIndex - 1);
                return;
            }
            
            console.log('Showing gift:', pattern);
            
            gameState.giftActive = true;
            gameState.giftStartTime = Date.now();
            gameState.giftIsDecoy = pattern.isDecoy;
            
            const gift = document.getElementById('gift');
            const giftImg = gift.querySelector('img');
            
            // ç”»åƒåˆ‡ã‚Šæ›¿ãˆ
            if (gameState.giftIsDecoy) {
                giftImg.src = 'images/hazuregift01.png';
                console.log('Showing decoy gift');
            } else {
                giftImg.src = 'images/gift01.png';
                console.log('Showing real gift');
            }
            
            // ä½ç½®è¨­å®š
            gift.style.left = pattern.position.x + '%';
            gift.style.top = pattern.position.y + '%';
            
            gift.style.opacity = '1';
            gift.classList.add('gift-active');
            
            console.log('Gift displayed at:', pattern.position);
            
            // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            if (gameState.hideGiftTimer) {
                clearTimeout(gameState.hideGiftTimer);
            }
            
            // è¡¨ç¤ºæ™‚é–“å¾Œã«è‡ªå‹•ã§æ¶ˆãˆã‚‹
            gameState.hideGiftTimer = setTimeout(() => {
                if (gameState.giftActive) {
                    console.log('Gift auto-hide after', boss.displayTime, 'ms');
                    gameState.giftActive = false;
                    gift.style.opacity = '0';
                    gift.classList.remove('gift-active');
                    
                    scheduleNextGift();
                }
            }, boss.displayTime);
        }

        function takeShot() {
            if (!gameState.gameRunning) {
                console.log('Game not running');
                return;
            }
            if (gameState.shutterRemaining <= 0) {
                console.log('No shutter remaining');
                return;
            }
            
            console.log('Shot taken! Gift active:', gameState.giftActive);
            
            // ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ã‚’æŠ¼ã—ãŸã‚‰å¿…ãšæ¸›ã‚‹
            gameState.shutterRemaining--;
            updateScoreDisplay();
            
            // ã‚®ãƒ•ãƒˆãŒãªã„æ™‚ã¯MISS
            if (!gameState.giftActive) {
                console.log('No gift active - MISS');
                showJudgment('MISS');
                updateFace();
                checkGameResult();
                return;
            }
            
            const boss = BOSSES[gameState.currentStage];
            const currentTime = Date.now();
            const elapsedTime = currentTime - gameState.giftStartTime;
            
            console.log('Elapsed time:', elapsedTime, 'ms');
            
            // ã‚®ãƒ•ãƒˆã‚’å³åº§ã«éã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
            gameState.giftActive = false;
            
            // ã‚®ãƒ•ãƒˆã‚’æ¶ˆã™ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            if (gameState.hideGiftTimer) {
                clearTimeout(gameState.hideGiftTimer);
                gameState.hideGiftTimer = null;
            }
            
            const gift = document.getElementById('gift');
            gift.style.opacity = '0';
            gift.classList.remove('gift-active');
            
            // ãƒã‚ºãƒ¬ã‚®ãƒ•ãƒˆã‚’æ’®å½±ã—ãŸå ´åˆ
            if (gameState.giftIsDecoy) {
                console.log('Decoy gift!');
                showJudgment('ãƒã‚ºãƒ¬ï¼');
                updateFace();
                checkGameResult();
                return;
            }
            
            // åˆ¤å®š: PERFECT 650ms / GOOD ãã‚Œä»¥é™
            let judgment = '';
            if (elapsedTime <= 650) {
                judgment = 'PERFECT';
                gameState.successCount++;
                gameState.perfectCount++;
            } else if (elapsedTime <= boss.displayTime) {
                judgment = 'GOOD';
                gameState.successCount++;
            } else {
                judgment = 'MISS';
            }
            
            console.log('Judgment:', judgment);
            
            showJudgment(judgment);
            updateScoreDisplay();
            updateFace();
            
            checkGameResult();
        }

        function showJudgment(type) {
            const judgment = document.getElementById('judgment');
            judgment.textContent = type;
            
            // ã‚¯ãƒ©ã‚¹åã‚’é©åˆ‡ã«è¨­å®š
            let className = 'judgment-';
            if (type === 'ãƒã‚ºãƒ¬ï¼') {
                className += 'hazure';
            } else {
                className += type.toLowerCase();
            }
            judgment.className = className;
            judgment.style.opacity = '1';
            
            setTimeout(() => {
                judgment.style.opacity = '0';
            }, 1000);
        }

        function checkGameResult() {
            const boss = BOSSES[gameState.currentStage];
            
            // ã‚¯ãƒªã‚¢æ¡ä»¶ãƒã‚§ãƒƒã‚¯
            if (gameState.successCount >= boss.requiredSuccess && 
                gameState.perfectCount >= boss.requiredPerfect) {
                stageClear();
                return;
            }
            
            // ã‚¯ãƒªã‚¢ä¸å¯èƒ½åˆ¤å®š
            const neededSuccess = boss.requiredSuccess - gameState.successCount;
            const neededPerfect = boss.requiredPerfect - gameState.perfectCount;
            
            if (gameState.shutterRemaining < neededSuccess || 
                gameState.shutterRemaining < neededPerfect) {
                gameOver();
                return;
            }
            
            // ã‚·ãƒ£ãƒƒã‚¿ãƒ¼æ®‹æ•°ãŒãªããªã£ãŸã‚‰ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®š
            if (gameState.shutterRemaining <= 0) {
                gameOver();
                return;
            }
            
            // ã¾ã ç¶šè¡Œå¯èƒ½
            scheduleNextGift();
        }

        function startCommentFlow() {
            const boss = BOSSES[gameState.currentStage];
            const comments = boss.comments;
            
            function addComment() {
                if (!gameState.gameRunning) return;
                
                const commentText = comments[Math.floor(Math.random() * comments.length)];
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment';
                commentDiv.textContent = commentText;
                
                const commentsContainer = document.getElementById('comments');
                commentsContainer.appendChild(commentDiv);
                
                while (commentsContainer.children.length > 5) {
                    commentsContainer.removeChild(commentsContainer.firstChild);
                }
                
                const delay = Math.random() * 1500 + 800;
                setTimeout(addComment, delay);
            }
            
            addComment();
        }

        function stageClear() {
            gameState.gameRunning = false;
            
            // ã™ã¹ã¦ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            if (gameState.giftTimer) {
                clearTimeout(gameState.giftTimer);
                gameState.giftTimer = null;
            }
            if (gameState.hideGiftTimer) {
                clearTimeout(gameState.hideGiftTimer);
                gameState.hideGiftTimer = null;
            }
            
            if (!gameState.clearedStages.includes(gameState.currentStage)) {
                gameState.clearedStages.push(gameState.currentStage);
                localStorage.setItem('clearedStages', JSON.stringify(gameState.clearedStages));
            }
            
            if (gameState.currentStage >= gameState.unlockedStage) {
                gameState.unlockedStage = gameState.currentStage + 1;
                localStorage.setItem('unlockedStage', gameState.unlockedStage.toString());
            }
            
            document.getElementById('clear-overlay').style.display = 'flex';
        }

        function gameOver() {
            gameState.gameRunning = false;
            
            // ã™ã¹ã¦ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            if (gameState.giftTimer) {
                clearTimeout(gameState.giftTimer);
                gameState.giftTimer = null;
            }
            if (gameState.hideGiftTimer) {
                clearTimeout(gameState.hideGiftTimer);
                gameState.hideGiftTimer = null;
            }
            
            document.getElementById('gameover-overlay').style.display = 'flex';
        }

        function retryStage() {
            document.getElementById('gameover-overlay').style.display = 'none';
            generateGiftPatterns(); // ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å†ç”Ÿæˆ
            startStage();
        }

        function nextStage() {
            document.getElementById('clear-overlay').style.display = 'none';
            gameState.currentStage++;
            
            if (gameState.currentStage >= BOSSES.length) {
                showScreen('game-complete');
            } else {
                showStageConfirm(); // ç¢ºèªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’è¡¨ç¤º
            }
        }

        function backToStageSelect() {
            document.getElementById('clear-overlay').style.display = 'none';
            document.getElementById('gameover-overlay').style.display = 'none';
            renderStageList();
            showScreen('stage-select-screen');
        }
    </script>
</body>
</html>