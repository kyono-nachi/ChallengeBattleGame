<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚®ãƒ•ãƒˆã¾ã‚“ãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>
    
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="icon/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="icon/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icon/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon/android-chrome-512x512.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
            background: #0a0a0a;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            overflow-y: auto;
            padding: 0;
        }

        /* PCè¡¨ç¤ºæ™‚ã®ã¿padding */
        @media (min-width: 481px) {
            body {
                padding: 20px 0;
            }
        }

        #game-container {
            width: 100%;
            max-width: 500px;
            height: auto;
            max-height: 100vh;
            background: #2c3e50;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
            margin: auto;
            aspect-ratio: 9 / 16;
        }

        /* å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
        }

        .screen.active {
            display: flex;
        }

        /* ãƒãƒ¼ã‚¿ãƒ«ç”»é¢ */
        #portal-screen {
            background: #00bfff;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
        }

        .game-title {
            font-size: 36px;
            color: #fff;
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
            text-align: center;
            line-height: 1.2;
        }

        .game-subtitle {
            font-size: 14px;
            color: #fff;
            margin-bottom: 30px;
            text-align: center;
            opacity: 0.9;
        }

        .portal-buttons {
            width: 100%;
            max-width: 350px;
        }

        .portal-button {
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            font-size: 16px;
            font-weight: bold;
            background: #ffffff;
            color: #00bfff;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .portal-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .portal-button.primary {
            background: #6778ff;
            color: white;
            font-size: 24px;
            padding: 22px;
        }

        .version-display {
            position: absolute;
            bottom: 15px;
            right: 15px;
            color: white;
            font-size: 12px;
            opacity: 0.6;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠï¼†é…ä¿¡è€…å¤‰æ›´ç”»é¢ */
        #stage-select-screen {
            background: #2c3e50;
            padding: 20px;
            overflow-y: auto;
        }

        .screen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }

        .back-to-portal {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .back-to-portal:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .screen-title {
            color: #fff;
            font-size: 24px;
            font-weight: bold;
        }

        /* é…ä¿¡è€…ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .streamer-section {
            background: #34495e;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .section-label {
            color: #aaa;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .current-streamer {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .streamer-avatar {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background: #00bfff;
        }

        .streamer-avatar.female {
            background: #6778ff;
        }

        .streamer-avatar.character3 {
            background: #ff69b4;
        }

        .streamer-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .streamer-info {
            flex: 1;
        }

        .streamer-name {
            color: #fff;
            font-size: 20px;
            font-weight: bold;
        }

        .change-streamer-btn {
            background: rgba(0, 191, 255, 0.3);
            border: 2px solid #00bfff;
            color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .change-streamer-btn:hover {
            background: rgba(0, 191, 255, 0.5);
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¸ãƒªã‚¹ãƒˆ */
        .stages-section {
            background: #34495e;
            border-radius: 15px;
            padding: 20px;
        }

        #stage-list {
            margin-top: 15px;
        }

        .stage-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .stage-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #00bfff;
            transform: translateX(5px);
        }

        .stage-item.cleared {
            background: rgba(0, 191, 255, 0.2);
            border-color: #00bfff;
        }

        .stage-item.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .stage-item.locked:hover {
            transform: none;
            border-color: transparent;
        }

        .stage-icon {
            font-size: 36px;
            margin-right: 12px;
        }

        .stage-info {
            flex: 1;
        }

        .stage-name {
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .stage-condition {
            color: #aaa;
            font-size: 12px;
        }

        .stage-status {
            color: #ffd700;
            font-size: 13px;
            font-weight: bold;
        }

        /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠç”»é¢ */
        #character-select-screen {
            background: rgba(0, 0, 0, 0.95);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #character-select-screen h2 {
            color: #fff;
            font-size: 32px;
            margin-bottom: 50px;
            text-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }

        .character-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px 40px;
            max-width: 400px;
            margin: 0 auto;
        }

        .character-option {
            cursor: pointer;
            transition: transform 0.3s;
            text-align: center;
        }

        .character-option:hover {
            transform: scale(1.1);
        }

        .character-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .character-option.disabled:hover {
            transform: none;
        }

        .character-box {
            width: 120px;
            height: 120px;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 3px solid #fff;
            transition: all 0.3s;
            margin-bottom: 15px;
            overflow: hidden;
            background: #00bfff;
        }

        .character-box.female {
            background: #6778ff;
        }

        .character-box.character3 {
            background: #ff69b4;
        }

        .character-box.coming-soon {
            background: #555;
            border-color: #777;
        }

        .coming-soon-text {
            color: #fff;
            font-size: 16px;
            font-weight: bold;
        }

        .character-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .character-option:hover .character-box {
            box-shadow: 0 0 30px rgba(255,255,255,0.5);
        }

        .character-name {
            color: #fff;
            font-size: 20px;
            font-weight: bold;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¸ç¢ºèªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ */
        #stage-confirm-screen {
            background: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            z-index: 500;
        }

        .confirm-overlay {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .confirm-window {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .confirm-boss-icon {
            font-size: 80px;
            margin-bottom: 15px;
        }

        .confirm-boss-name {
            font-size: 24px;
            font-weight: bold;
            color: #00bfff;
            margin-bottom: 15px;
        }

        .confirm-boss-quote {
            font-size: 16px;
            color: #333;
            margin-bottom: 25px;
            line-height: 1.6;
            font-style: italic;
        }

        .confirm-divider {
            height: 2px;
            background: linear-gradient(to right, transparent, #00bfff, transparent);
            margin: 20px 0;
        }

        .confirm-condition {
            margin-bottom: 20px;
        }

        .confirm-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .confirm-value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .confirm-difficulty {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .difficulty-tag {
            background: rgba(103, 120, 255, 0.1);
            border: 2px solid #6778ff;
            color: #6778ff;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
        }

        .confirm-start-btn {
            width: 100%;
            padding: 18px;
            font-size: 20px;
            font-weight: bold;
            background: #00bfff;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .confirm-start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 191, 255, 0.4);
        }

        .confirm-back-btn {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            background: transparent;
            color: #666;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .confirm-back-btn:hover {
            color: #333;
        }

        /* æ®‹ã‚Šã‚®ãƒ•ãƒˆè¡¨ç¤º */
        #remaining-gifts-display {
            position: absolute;
            top: 70px; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä¸‹ */
            left: 0;
            right: 0;
            padding: 8px 0 8px 15px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            z-index: 11;
            display: flex;
            justify-content: flex-start;
        }

        #remaining-gifts-icons {
            display: flex;
            gap: 4px;
            justify-content: center;
        }

        .gift-icon {
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            backdrop-filter: blur(3px);
            transition: all 0.3s;
        }

        .gift-icon.used {
            opacity: 0.3;
            transform: scale(0.8);
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ */
        #game-screen {
            flex-direction: column;
            position: relative;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        #header {
            background: rgba(0, 0, 0, 0.6);
            padding: 12px 15px;
            color: white;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
            backdrop-filter: blur(5px);
        }

        .boss-info {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }

        .boss-icon {
            font-size: 24px;
            margin-right: 8px;
        }

        .boss-name {
            font-size: 18px;
            font-weight: bold;
            flex: 1;
        }

        .stage-number {
            font-size: 12px;
            color: #ffd700;
        }

        .boss-condition {
            font-size: 12px;
            color: #ccc;
            margin-left: 32px;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ - ã‚¢ãƒã‚¿ãƒ¼å…¨é¢è¡¨ç¤º */
        #main-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding: 0;
        }

        #streamer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0;
            margin: 0;
            background: #00bfff;
            z-index: 1;
        }

        #streamer.female {
            background: #6778ff;
        }

        #streamer.character3 {
            background: #ff69b4;
        }

        #streamer img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* æ¸¬å®šãƒ¢ãƒ¼ãƒ‰ç”¨ã®streamer */
        #measurement-streamer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0;
            margin: 0;
            background: #00bfff;
            z-index: 1;
        }

        #measurement-streamer img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* æ¸¬å®šãƒ¢ãƒ¼ãƒ‰ç”¨ã®gift */
        #measurement-gift {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            opacity: 0;
            pointer-events: none;
            animation: none;
            z-index: 5;
        }

        #measurement-gift img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.8));
        }

        /* æ¸¬å®šãƒ¢ãƒ¼ãƒ‰ç”»é¢å°‚ç”¨CSS */
        #measurement-header {
            background: rgba(0, 0, 0, 0.6);
            padding: 12px 15px;
            color: white;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
            backdrop-filter: blur(5px);
        }

        #measurement-main-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding: 0;
        }

        #measurement-score-display {
            position: absolute;
            top: 130px;
            right: 15px;
            color: white;
            text-align: right;
            font-size: 13px;
            background: rgba(0,0,0,0.4);
            padding: 8px 12px;
            border-radius: 8px;
            z-index: 10;
            backdrop-filter: blur(5px);
        }

        /* æ¸¬å®šãƒ¢ãƒ¼ãƒ‰ç”¨ã®åˆ¤å®š */
        #measurement-judgment {
            position: absolute;
            top: 35%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            pointer-events: none;
            z-index: 20;
        }

        #measurement-judgment-img {
            width: 250px;
            height: auto;
            display: none;
        }

        #measurement-judgment-text {
            font-size: 48px;
            font-weight: bold;
            background: white;
            padding: 15px 30px;
            border-radius: 12px;
            border: 3px solid #ff6b6b;
            color: #ff6b6b;
            display: none;
            white-space: nowrap;
        }

        .judgment-perfect #measurement-judgment-img,
        .judgment-good #measurement-judgment-img {
            display: block;
        }

        .judgment-miss #measurement-judgment-text,
        .judgment-hazure #measurement-judgment-text {
            display: block;
        }

        /* æ¸¬å®šãƒ¢ãƒ¼ãƒ‰ç”¨ã®ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³ */
        #measurement-shutter-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            border: 4px solid rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
            overflow: hidden;
            z-index: 15;
            position: relative;
            margin-bottom: 200px;
            backdrop-filter: blur(5px);
        }

        #measurement-shutter-button img {
            width: 50%;
            height: 50%;
            object-fit: contain;
            filter: brightness(0) invert(1);
            opacity: 0.9;
        }

        #measurement-shutter-button:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.5);
        }

        #measurement-shutter-button:active {
            transform: scale(0.9);
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }

        /* æ¸¬å®šãƒ¢ãƒ¼ãƒ‰ç”¨ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¨ãƒªã‚¢ */
        #measurement-comment-area {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 180px;
            background: rgba(255, 255, 255, 0.85);
            padding: 15px;
            overflow: hidden;
            z-index: 10;
            backdrop-filter: blur(10px);
        }

        #measurement-comments {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 0 15px 15px;
        }

        #gift {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            opacity: 0;
            pointer-events: none;
            animation: none;
            z-index: 5;
        }

        #gift img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.8));
        }

        @keyframes popup {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            10% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            20% { transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }

        .gift-active {
            animation: popup 1s ease-out;
        }

        /* ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³ - ãƒ¢ãƒã‚¯ãƒ­ï¼‹é€é */
        #shutter-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            border: 4px solid rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
            overflow: hidden;
            z-index: 15;
            position: relative;
            margin-bottom: 200px;
            backdrop-filter: blur(5px);
        }

        #shutter-button img {
            width: 50%;
            height: 50%;
            object-fit: contain;
            filter: brightness(0) invert(1);
            opacity: 0.9;
        }

        #shutter-button:active {
            transform: scale(0.9);
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
            background: rgba(255, 255, 255, 0.5);
        }

        /* ã‚¹ã‚³ã‚¢è¡¨ç¤º */
        #score-display {
            position: absolute;
            top: 130px;
            right: 15px;
            color: white;
            text-align: right;
            font-size: 13px;
            background: rgba(0,0,0,0.4);
            padding: 8px 12px;
            border-radius: 8px;
            z-index: 10;
            backdrop-filter: blur(5px);
        }

        .score-item {
            margin: 4px 0;
        }

        .score-label {
            color: #ddd;
            font-size: 11px;
        }

        .score-value {
            font-weight: bold;
            font-size: 16px;
            color: #ffd700;
        }

        .quit-game-btn {
            margin-top: 10px;
            padding: 6px 12px;
            background: rgba(255, 59, 59, 0.8);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
        }

        .quit-game-btn:hover {
            background: rgba(255, 59, 59, 1);
            transform: translateY(-1px);
        }

        .quit-game-btn:active {
            transform: translateY(0);
        }

        #judgment {
            position: absolute;
            top: 35%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            pointer-events: none;
            z-index: 20;
        }

        #judgment-img {
            width: 250px;
            height: auto;
            display: none;
        }

        #judgment-text {
            font-size: 48px;
            font-weight: bold;
            background: white;
            padding: 15px 30px;
            border-radius: 12px;
            border: 3px solid #ff6b6b;
            color: #ff6b6b;
            display: none;
            white-space: nowrap;
        }

        .judgment-perfect #judgment-img,
        .judgment-good #judgment-img {
            display: block;
        }

        .judgment-miss #judgment-text,
        .judgment-hazure #judgment-text {
            display: block;
        }

        .judgment-perfect {
            animation: judgment-anim 1s ease-out;
        }

        .judgment-good {
            animation: judgment-anim 1s ease-out;
        }

        .judgment-miss {
            animation: judgment-anim 1s ease-out;
        }

        .judgment-hazure {
            animation: judgment-anim 1s ease-out;
        }

        @keyframes judgment-anim {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }

        /* ã‚³ãƒ¡ãƒ³ãƒˆã‚¨ãƒªã‚¢ - åŠé€æ˜ç™½èƒŒæ™¯ */
        #comment-area {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 180px;
            background: rgba(255, 255, 255, 0.85);
            padding: 15px;
            overflow: hidden;
            z-index: 10;
            backdrop-filter: blur(10px);
        }

        #comments {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 0 15px 15px;
        }

        .comment {
            color: #1a1a1a;
            padding: 6px 10px;
            margin: 4px 0;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            font-size: 12px;
            opacity: 0;
            transform: translateY(20px);
            animation: comment-in 0.3s ease-out forwards;
            font-weight: 500;
        }

        @keyframes comment-in {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ã‚¯ãƒªã‚¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #clear-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .clear-message {
            font-size: 50px;
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 30px;
            text-shadow: 0 4px 8px rgba(0,0,0,0.5);
            animation: clear-pulse 1s ease-in-out infinite;
        }

        @keyframes clear-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .block-message {
            font-size: 35px;
            color: #03ffff;
            font-weight: bold;
            margin-bottom: 20px;
            padding: 15px 30px;
            background: rgba(3, 255, 255, 0.2);
            border: 3px solid #03ffff;
            border-radius: 15px;
        }

        .next-button {
            margin-top: 10px;
            padding: 15px 40px;
            font-size: 20px;
            background: #00bfff;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .next-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(0, 191, 255, 0.5);
        }

        .next-button.secondary {
            background: #6778ff;
        }

        #gameover-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .gameover-message {
            font-size: 50px;
            color: #6778ff;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }

        .gameover-subtitle {
            font-size: 30px;
            color: #fff;
            margin-bottom: 30px;
        }

        #game-complete {
            background: #00bfff;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }

        .complete-title {
            font-size: 45px;
            color: #fff;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .complete-subtitle {
            font-size: 24px;
            color: #fff;
            margin-bottom: 40px;
        }

        .restart-button {
            padding: 20px 50px;
            font-size: 24px;
            background: white;
            color: #00bfff;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .restart-button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 40px rgba(255,255,255,0.8);
        }

        /* æƒ…å ±ç”»é¢ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .info-screen {
            padding: 30px 20px;
            overflow-y: auto;
        }

        .info-content {
            color: #fff;
            line-height: 1.8;
        }

        .info-content h3 {
            font-size: 24px;
            margin: 25px 0 15px;
            color: #03ffff;
        }

        .info-content p {
            margin-bottom: 15px;
        }

        .news-date {
            font-size: 14px;
            color: #999;
            margin-bottom: 10px !important;
        }

        .howto-image-container {
            text-align: center;
            margin: 15px 0;
        }

        .howto-image {
            max-width: 200px;
            height: auto;
            margin: 10px 0;
        }

        .howto-caption {
            font-size: 14px;
            color: #03ffff;
            margin-top: 5px;
        }

        /* ã‚¹ãƒãƒ›è¡¨ç¤ºæœ€é©åŒ– */
        @media (max-width: 480px) {
            #game-container {
                max-width: 100%;
                aspect-ratio: auto;
                height: 100vh;
            }

            .comment {
                font-size: 12px;
                padding: 6px 10px;
                margin: 4px 0;
            }

            .game-title {
                font-size: 28px;
            }

            .game-subtitle {
                font-size: 12px;
            }

            .portal-button {
                padding: 12px;
                font-size: 14px;
                margin: 8px 0;
            }

            .portal-button.primary {
                font-size: 18px;
                padding: 16px;
            }

            .screen-title {
                font-size: 18px;
            }

            .boss-icon {
                font-size: 20px;
                margin-right: 6px;
            }

            .boss-name {
                font-size: 14px;
            }

            .stage-number {
                font-size: 10px;
            }

            .boss-condition {
                font-size: 10px;
                margin-left: 26px;
            }

            .score-display {
                font-size: 11px;
            }

            .score-value {
                font-size: 14px;
            }

            .stage-card {
                padding: 12px;
            }

            .stage-boss-icon {
                font-size: 32px;
            }

            .stage-boss-name {
                font-size: 14px;
            }

            .stage-condition {
                font-size: 11px;
            }

            .confirm-boss-icon {
                font-size: 60px;
            }

            .confirm-boss-name {
                font-size: 20px;
            }

            .confirm-boss-quote {
                font-size: 12px;
            }

            .confirm-condition {
                font-size: 12px;
            }

            .difficulty-tag {
                font-size: 10px;
                padding: 4px 8px;
            }

            .info-content {
                font-size: 14px;
            }

            .info-content h3 {
                font-size: 20px;
            }

            .quit-game-btn {
                font-size: 11px;
                padding: 5px 10px;
            }

            .gift-icon {
                width: 16px;
                height: 16px;
                font-size: 10px;
            }

            #header {
                padding: 8px 12px;
            }

            #remaining-gifts-display {
                top: 70px;
                padding: 6px 0 6px 12px;
            }

            #score-display {
                top: 120px;
                padding: 6px 10px;
                font-size: 11px;
            }

            #judgment-img {
                width: 180px;
            }

            /* æ¸¬å®šãƒ¢ãƒ¼ãƒ‰ç”¨ã‚¹ãƒãƒ›å¯¾å¿œ */
            #measurement-header {
                padding: 8px 12px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- ãƒãƒ¼ã‚¿ãƒ«ç”»é¢ -->
        <div id="portal-screen" class="screen active">
            <div class="game-title">ã‚®ãƒ•ãƒˆã¾ã‚“<br>ãƒãƒ£ãƒ¬ãƒ³ã‚¸</div>
            <div class="game-subtitle">åå°„ç¥çµŒã§ãƒœã‚¹ã‚’æ’ƒç ´ã›ã‚ˆï¼</div>
            <div class="portal-buttons">
                <button class="portal-button primary" onclick="startGame()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
                <button class="portal-button" onclick="showScreen('story-screen')">ã‚¹ãƒˆãƒ¼ãƒªãƒ¼</button>
                <button class="portal-button" onclick="showScreen('howto-screen')">éŠã³æ–¹</button>
                <button class="portal-button" onclick="startMeasurementMode()">æ¸¬å®šãƒ¢ãƒ¼ãƒ‰</button>
                <button class="portal-button" onclick="showScreen('ranking-screen')">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
                <button class="portal-button" onclick="showScreen('news-screen')">ãŠçŸ¥ã‚‰ã›</button>
            </div>
            <div class="version-display">beta 1.0</div>
        </div>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠï¼†é…ä¿¡è€…å¤‰æ›´ç”»é¢ -->
        <div id="stage-select-screen" class="screen">
            <div class="screen-header">
                <button class="back-to-portal" onclick="showScreen('portal-screen')">æˆ»ã‚‹</button>
                <div class="screen-title">ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠ</div>
                <div style="width: 60px;"></div>
            </div>

            <div class="streamer-section">
                <div class="section-label">é…ä¿¡è€…</div>
                <div class="current-streamer">
                    <div class="streamer-avatar" id="current-avatar">
                        <img src="images/character01_1.png" alt="é…ä¿¡è€…">
                    </div>
                    <div class="streamer-info">
                        <div class="streamer-name" id="current-name">Aã•ã‚“</div>
                    </div>
                    <button class="change-streamer-btn" onclick="showScreen('character-select-screen')">å¤‰æ›´</button>
                </div>
            </div>

            <div class="stages-section">
                <div class="section-label">ã‚¹ãƒ†ãƒ¼ã‚¸</div>
                <div id="stage-list"></div>
            </div>
        </div>

        <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠç”»é¢ -->
        <div id="character-select-screen" class="screen">
            <h2>é…ä¿¡è€…ã‚’é¸ã¼ã†</h2>
            <div class="character-options">
                <div class="character-option" onclick="selectCharacter('male', 'Aã•ã‚“')">
                    <div class="character-box">
                        <img src="images/character01_1.png" alt="Aã•ã‚“">
                    </div>
                    <div class="character-name">Aã•ã‚“</div>
                </div>
                <div class="character-option" onclick="selectCharacter('female', 'Bã•ã‚“')">
                    <div class="character-box female">
                        <img src="images/character02_1.png" alt="Bã•ã‚“">
                    </div>
                    <div class="character-name">Bã•ã‚“</div>
                </div>
                <div class="character-option" onclick="selectCharacter('character3', 'Cã•ã‚“')">
                    <div class="character-box character3">
                        <img src="images/character03_1.png" alt="Cã•ã‚“">
                    </div>
                    <div class="character-name">Cã•ã‚“</div>
                </div>
                <div class="character-option disabled">
                    <div class="character-box coming-soon">
                        <div class="coming-soon-text">æº–å‚™ä¸­</div>
                    </div>
                    <div class="character-name">Dã•ã‚“</div>
                </div>
                <div class="character-option disabled">
                    <div class="character-box coming-soon">
                        <div class="coming-soon-text">æº–å‚™ä¸­</div>
                    </div>
                    <div class="character-name">Eã•ã‚“</div>
                </div>
                <div class="character-option disabled">
                    <div class="character-box coming-soon">
                        <div class="coming-soon-text">æº–å‚™ä¸­</div>
                    </div>
                    <div class="character-name">Fã•ã‚“</div>
                </div>
                <div class="character-option disabled">
                    <div class="character-box coming-soon">
                        <div class="coming-soon-text">æº–å‚™ä¸­</div>
                    </div>
                    <div class="character-name">Gã•ã‚“</div>
                </div>
                <div class="character-option disabled">
                    <div class="character-box coming-soon">
                        <div class="coming-soon-text">æº–å‚™ä¸­</div>
                    </div>
                    <div class="character-name">Hã•ã‚“</div>
                </div>
            </div>
        </div>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¸ç¢ºèªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ -->
        <div id="stage-confirm-screen" class="screen">
            <div class="confirm-overlay">
                <div class="confirm-window">
                    <div class="confirm-boss-icon" id="confirm-boss-icon">ğŸ‘¶</div>
                    <div class="confirm-boss-name" id="confirm-boss-name">ã‚­ãƒƒã‚ºã‚³ãƒ¡ãƒ³ãƒˆ</div>
                    <div class="confirm-boss-quote" id="confirm-boss-quote">ã€Œã­ã‡ã­ã‡ã€èã„ã¦èã„ã¦ï½ï¼ã€</div>
                    
                    <div class="confirm-divider"></div>
                    
                    <div class="confirm-condition">
                        <div class="confirm-label">é”æˆæ¡ä»¶</div>
                        <div class="confirm-value" id="confirm-condition-text">5æšä¸­3æšæˆåŠŸ</div>
                    </div>
                    
                    <div class="confirm-difficulty" id="confirm-difficulty">
                        <div class="difficulty-tag">å‡ºç¾ä½ç½®ãƒ©ãƒ³ãƒ€ãƒ </div>
                        <div class="difficulty-tag">ãƒã‚ºãƒ¬ã‚®ãƒ•ãƒˆã‚ã‚Š</div>
                    </div>
                    
                    <button class="confirm-start-btn" onclick="startGameFromConfirm()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                    <button class="confirm-back-btn" onclick="backToStageSelectFromConfirm()">æˆ»ã‚‹</button>
                </div>
            </div>
        </div>

        <!-- æ¸¬å®šãƒ¢ãƒ¼ãƒ‰ç”»é¢ -->
        <div id="measurement-screen" class="screen">
            <div id="measurement-header">
                <div class="boss-info">
                    <span class="boss-icon">â±ï¸</span>
                    <span class="boss-name">æ¸¬å®šãƒ¢ãƒ¼ãƒ‰</span>
                </div>
                <div class="boss-condition">åå¿œé€Ÿåº¦ã‚’æ¸¬å®šã—ã‚ˆã†</div>
            </div>

            <div id="measurement-main-area">
                <div id="measurement-score-display">
                    <div class="score-item">
                        <span class="score-label">æ¸¬å®š:</span>
                        <span class="score-value" id="measurement-count">0/5</span>
                    </div>
                    <button class="quit-game-btn" onclick="quitMeasurement()">çµ‚äº†</button>
                </div>

                <div id="measurement-streamer">
                    <img id="measurement-streamer-img" src="images/character01_1.png" alt="é…ä¿¡è€…">
                </div>

                <div id="measurement-gift" class="gift">
                    <img src="images/gift01.png" alt="ã‚®ãƒ•ãƒˆ">
                </div>

                <div id="measurement-judgment">
                    <img id="measurement-judgment-img" src="" alt="åˆ¤å®š">
                    <div id="measurement-judgment-text"></div>
                </div>

                <button id="measurement-shutter-button">
                    <img src="images/shutter.png" alt="ã‚·ãƒ£ãƒƒã‚¿ãƒ¼">
                </button>
            </div>

            <div id="measurement-comment-area">
                <div id="measurement-comments"></div>
            </div>
        </div>

        <!-- æ¸¬å®šçµæœã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ -->
        <div id="measurement-result-screen" class="screen">
            <div class="confirm-overlay">
                <div class="confirm-window">
                    <h2 style="color: #000; margin-bottom: 20px;">æ¸¬å®šçµæœ</h2>
                    <div id="measurement-results-list" style="color: #000; font-size: 16px; line-height: 2; text-align: left;">
                        <!-- çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>
                    <button class="confirm-start-btn" onclick="restartMeasurement()">ã‚‚ã†ä¸€åº¦</button>
                    <button class="confirm-back-btn" onclick="showScreen('portal-screen')">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
                </div>
            </div>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div id="game-screen" class="screen">
            <div id="header">
                <div class="boss-info">
                    <span class="boss-icon" id="boss-icon">ğŸ‘¶</span>
                    <span class="boss-name" id="boss-name">ã‚­ãƒƒã‚ºã‚³ãƒ¡ãƒ³ãƒˆ</span>
                    <span class="stage-number" id="stage-number">STAGE 1/14</span>
                </div>
                <div class="boss-condition" id="boss-condition">æ¡ä»¶: 5æšä¸­3æšæˆåŠŸ</div>
            </div>

            <div id="main-area">
                <div id="score-display">
                    <div class="score-item">
                        <span class="score-label">æˆåŠŸ:</span>
                        <span class="score-value" id="success-count">0/3</span>
                    </div>
                    <div class="score-item">
                        <span class="score-value" id="perfect-count">PERFECT: 0</span>
                    </div>
                    <div class="score-item">
                        <span class="score-label">ã‚·ãƒ£ãƒƒã‚¿ãƒ¼:</span>
                        <span class="score-value" id="shot-count">20å›</span>
                    </div>
                    <button class="quit-game-btn" onclick="quitGame()">ã‚²ãƒ¼ãƒ çµ‚äº†</button>
                </div>

                <div id="remaining-gifts-display">
                    <div id="remaining-gifts-icons"></div>
                </div>

                <div id="streamer">
                    <img id="streamer-image" src="images/character01_1.png" alt="é…ä¿¡è€…">
                </div>

                <div id="gift">
                    <img src="images/gift01.png" alt="ã‚®ãƒ•ãƒˆ">
                </div>
                <div id="judgment">
                    <img id="judgment-img" src="" alt="åˆ¤å®š">
                    <span id="judgment-text"></span>
                </div>

                <button id="shutter-button" onclick="takeShot()">
                    <img src="images/shutter.png" alt="ã‚·ãƒ£ãƒƒã‚¿ãƒ¼">
                </button>
            </div>

            <div id="comment-area">
                <div id="comments"></div>
            </div>

            <div id="clear-overlay">
                <div class="clear-message">STAGE CLEAR!</div>
                <div class="block-message">ãƒãƒ£ãƒ¬ãƒ³ã‚¸æˆåŠŸï¼</div>
                <button class="next-button" onclick="nextStage()">æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸</button>
                <button class="next-button secondary" onclick="backToStageSelect()">ã‚¹ãƒ†ãƒ¼ã‚¸ä¸€è¦§ã¸</button>
            </div>

            <div id="gameover-overlay">
                <div class="gameover-message">GAME OVER</div>
                <div class="gameover-subtitle">å¤±æ•—...</div>
                <button class="next-button" onclick="retryStage()">ãƒªãƒˆãƒ©ã‚¤</button>
                <button class="next-button secondary" onclick="backToStageSelect()">ã‚¹ãƒ†ãƒ¼ã‚¸ä¸€è¦§ã¸</button>
            </div>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ç”»é¢ -->
        <div id="game-complete" class="screen">
            <div class="complete-title">GAME COMPLETE!</div>
            <div class="complete-subtitle">å¹³å’Œãªé…ä¿¡ç©ºé–“ã‚’å–ã‚Šæˆ»ã—ãŸï¼</div>
            <button class="restart-button" onclick="showScreen('portal-screen')">ãƒãƒ¼ã‚¿ãƒ«ã¸æˆ»ã‚‹</button>
        </div>

        <!-- ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç”»é¢ -->
        <div id="story-screen" class="screen info-screen">
            <div class="screen-header">
                <button class="back-to-portal" onclick="showScreen('portal-screen')">æˆ»ã‚‹</button>
                <div class="screen-title">ã‚¹ãƒˆãƒ¼ãƒªãƒ¼</div>
                <div style="width: 60px;"></div>
            </div>
            <div class="info-content">
                <p>ã‚ã‚‹æ—¥ã€å¹³å’Œã ã£ãŸé…ä¿¡ç©ºé–“ã«ç¾ã‚ŒãŸå„ä»‹ãªå­˜åœ¨ãŸã¡...</p>
                <p>ã‚­ãƒƒã‚ºã€è’ã‚‰ã—ã€ã‚»ã‚¯ãƒãƒ©ã€è¿·æƒ‘è‡ªèªã‚Šã€ãã—ã¦æœ€å‡¶ã®ã€Œå¾¡æ°—æŒè¡¨æ˜ç²˜ç€åè»¢ã€ã¾ã§ã€‚</p>
                <p>é…ä¿¡è€…ã¨ã—ã¦ã€å›ã¯ã€Œã‚®ãƒ•ãƒˆã¾ã‚“ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã€ã®æŠ€è¡“ã‚’ä½¿ã£ã¦ã€ã“ã‚Œã‚‰ã®å„ä»‹è€…ãŸã¡ã‚’æ’ƒé€€ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ï¼</p>
                <p>ä¸€ç¬ã§æ¶ˆãˆã‚‹ã‚®ãƒ•ãƒˆã¾ã‚“ã‚’å®Œç’§ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§æ’®å½±ã—ã€ãƒœã‚¹ãŸã¡ã‚’æ’ƒç ´ã™ã‚‹ã®ã ï¼</p>
            </div>
        </div>

        <!-- éŠã³æ–¹ç”»é¢ -->
        <div id="howto-screen" class="screen info-screen">
            <div class="screen-header">
                <button class="back-to-portal" onclick="showScreen('portal-screen')">æˆ»ã‚‹</button>
                <div class="screen-title">éŠã³æ–¹</div>
                <div style="width: 60px;"></div>
            </div>
            <div class="info-content">
                <h3>ã‚²ãƒ¼ãƒ ã®ç›®çš„</h3>
                <p>ç”»é¢ã«å‡ºç¾ã™ã‚‹ã€Œã‚®ãƒ•ãƒˆã¾ã‚“ã€ã‚’ã€ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã§ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚ˆãæ’®å½±ã—ã¦ã€é…ä¿¡è€…ã«è¿«ã‚‹ãƒœã‚¹ã‚’æ’ƒç ´ã—ã‚ˆã†ï¼</p>
                
                <h3>æ“ä½œæ–¹æ³•</h3>
                <p>ç”»é¢ä¸‹éƒ¨ã®<strong>ğŸ“·ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³</strong>ã‚’ã‚¿ãƒƒãƒ—ï¼ˆã‚¯ãƒªãƒƒã‚¯ï¼‰ã—ã¦æ’®å½±ã—ã¾ã™ã€‚</p>
                <p>ã‚®ãƒ•ãƒˆã¾ã‚“ãŒç”»é¢ã«ç¾ã‚ŒãŸã‚‰ã€ã™ã‹ã•ãšã‚·ãƒ£ãƒƒã‚¿ãƒ¼ã‚’æŠ¼ãã†ï¼</p>
                
                <h3>åˆ¤å®šã«ã¤ã„ã¦</h3>
                <p>æ’®å½±ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ã‚ˆã£ã¦ã€åˆ¤å®šãŒå¤‰ã‚ã‚Šã¾ã™ï¼š</p>
                <div class="howto-image-container">
                    <img src="images/hantei_perfect.png" alt="PERFECTåˆ¤å®š" class="howto-image">
                    <p class="howto-caption"><strong>PERFECT:</strong> æœ€é«˜ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼</p>
                </div>
                <div class="howto-image-container">
                    <img src="images/hantei_good.png" alt="NICEåˆ¤å®š" class="howto-image">
                    <p class="howto-caption"><strong>NICE:</strong> æˆåŠŸï¼</p>
                </div>
                <p><strong>MISS:</strong> ã‚®ãƒ•ãƒˆã¾ã‚“ãŒæ¶ˆãˆã¦ã—ã¾ã£ãŸã€ã¾ãŸã¯ã‚®ãƒ•ãƒˆãŒãªã„ã®ã«ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ã‚’æŠ¼ã—ãŸ...</p>
                
                <h3>ã‚·ãƒ£ãƒƒã‚¿ãƒ¼åˆ¶é™</h3>
                <p>å„ã‚¹ãƒ†ãƒ¼ã‚¸ã«ã¯<strong>ã‚·ãƒ£ãƒƒã‚¿ãƒ¼å›æ•°ã®åˆ¶é™</strong>ãŒã‚ã‚Šã¾ã™ã€‚</p>
                <p>ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ã‚’æŠ¼ã™ãŸã³ã«ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã€åˆ¶é™å›æ•°ã‚’ä½¿ã„åˆ‡ã‚‹ã¨ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã§ã™ã€‚</p>
                <p>ã‚€ã‚„ã¿ã«ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ã‚’æŠ¼ã•ãšã€ã‚®ãƒ•ãƒˆã¾ã‚“ãŒå‡ºç¾ã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ç‹™ã„ã¾ã—ã‚‡ã†ï¼</p>
                <p>å¾ŒåŠã®ã‚¹ãƒ†ãƒ¼ã‚¸ã»ã©ã‚·ãƒ£ãƒƒã‚¿ãƒ¼åˆ¶é™ãŒå³ã—ããªã‚Šã¾ã™ã€‚</p>
                
                <h3>ãƒã‚ºãƒ¬ã‚®ãƒ•ãƒˆã«æ³¨æ„ï¼</h3>
                <p>å¾ŒåŠã®ã‚¹ãƒ†ãƒ¼ã‚¸ã§ã¯ã€<strong>ãƒã‚ºãƒ¬ã‚®ãƒ•ãƒˆ</strong>ãŒå‡ºç¾ã—ã¾ã™ã€‚</p>
                <p>ãƒã‚ºãƒ¬ã‚®ãƒ•ãƒˆã‚’æ’®å½±ã™ã‚‹ã¨ã€Œãƒã‚ºãƒ¬ï¼ã€ã¨è¡¨ç¤ºã•ã‚Œã€æˆåŠŸæ•°ã«ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã¾ã›ã‚“ã€‚</p>
                
                <h3>æ®‹ã‚Šã‚®ãƒ•ãƒˆæ•°</h3>
                <p>ç”»é¢ä¸Šéƒ¨ã«è¡¨ç¤ºã•ã‚Œã‚‹ <strong>ğŸğŸğŸ...</strong> ãŒæ®‹ã‚Šã®ãƒãƒ£ãƒ³ã‚¹ï¼ˆã‚ãŸã‚Šã‚®ãƒ•ãƒˆï¼‰ã®æ•°ã§ã™ã€‚</p>
                <p>æœ¬ç‰©ã®ã‚®ãƒ•ãƒˆã¾ã‚“ãŒå‡ºç¾ã™ã‚‹ãŸã³ã«ã€1ã¤ãšã¤æ¸›ã£ã¦ã„ãã¾ã™ã€‚</p>
                <p>â€»ãƒã‚ºãƒ¬ã‚®ãƒ•ãƒˆã§ã¯æ¸›ã‚Šã¾ã›ã‚“</p>
                
                <h3>ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢æ¡ä»¶</h3>
                <p>å„ã‚¹ãƒ†ãƒ¼ã‚¸ã«ã¯ã€<strong>æˆåŠŸæ•°</strong>ã¨<strong>PERFECTå›æ•°</strong>ã®æ¡ä»¶ãŒã‚ã‚Šã¾ã™ã€‚</p>
                <p>ã‚¹ãƒ†ãƒ¼ã‚¸ç¢ºèªç”»é¢ã§æ¡ä»¶ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚</p>
                <p>å¾ŒåŠã®ã‚¹ãƒ†ãƒ¼ã‚¸ã»ã©æ¡ä»¶ãŒå³ã—ããªã‚Šã¾ã™ï¼</p>
                
                <h3>è¡¨æƒ…ã«æ³¨ç›®ï¼</h3>
                <p>é…ä¿¡è€…ã®è¡¨æƒ…ãŒå¤‰åŒ–ã—ã¾ã™ï¼š</p>
                <p><strong>é€šå¸¸é¡”ï¼š</strong> ã¾ã ä½™è£•ãŒã‚ã‚‹</p>
                <p><strong>å›°ã‚Šé¡”ï¼š</strong> ã‚‚ã†ãƒŸã‚¹ã§ããªã„ï¼</p>
                <p><strong>å¾—æ„é¡”ï¼š</strong> ã‚ã¨1å›ã§æˆåŠŸ or ã‚¯ãƒªã‚¢é”æˆ</p>
            </div>
        </div>

        <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ -->
        <div id="ranking-screen" class="screen info-screen">
            <div class="screen-header">
                <button class="back-to-portal" onclick="showScreen('portal-screen')">æˆ»ã‚‹</button>
                <div class="screen-title">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
                <div style="width: 60px;"></div>
            </div>
            <div class="info-content">
                <p style="text-align: center; padding: 40px 0;">æº–å‚™ä¸­</p>
                <p style="text-align: center;">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ã¯å¾Œæ—¥å®Ÿè£…äºˆå®šã§ã™ï¼</p>
            </div>
        </div>

        <!-- ãŠçŸ¥ã‚‰ã›ç”»é¢ -->
        <div id="news-screen" class="screen info-screen">
            <div class="screen-header">
                <button class="back-to-portal" onclick="showScreen('portal-screen')">æˆ»ã‚‹</button>
                <div class="screen-title">ãŠçŸ¥ã‚‰ã›</div>
                <div style="width: 60px;"></div>
            </div>
            <div class="info-content">
                <h3>beta 1.0 ãƒªãƒªãƒ¼ã‚¹</h3>
                <p class="news-date">2026/01/14</p>
                <p>ã‚®ãƒ•ãƒˆã¾ã‚“ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã€é–‹ç™ºç‰ˆãŒãƒªãƒªãƒ¼ã‚¹ï¼</p>
                <p>å…¨14ã‚¹ãƒ†ãƒ¼ã‚¸ã§é…ä¿¡è€…ã‚’å®ˆã‚ŠæŠœã“ã†ï¼</p>
            </div>
        </div>
    </div>

    <script>
        const BOSSES = [
            {
                name: 'ã‚­ãƒƒã‚ºã‚³ãƒ¡ãƒ³ãƒˆ',
                icon: 'ğŸ‘¶',
                quote: 'ã­ã‡ã­ã‡ã€èã„ã¦èã„ã¦ï½ï¼',
                displayTime: 600,
                perfectThreshold: 370,
                totalGifts: 10,
                requiredSuccess: 2,
                requiredPerfect: 0,
                maxShots: 20,
                hasDecoy: false,
                randomPosition: false,
                comments: ['ã­ã‡ã­ã‡', 'ã‚ã®ã•ãƒ¼', 'å£°çœŸä¼¼ã—ã¦', 'è³ªå•ã„ã„ï¼Ÿ', 'ã­ã‡èã„ã¦ã‚‹ï¼Ÿ', 'æ•™ãˆã¦æ•™ãˆã¦', 'å®¿é¡Œã‚„ã‚‰ãªãã‚ƒ', 'èã„ã¦ãã‚Œã‚‹ï¼Ÿ', 'ã‚ã‹ã‚“ãªã„ã‚“ã ã‘ã©', 'ã“ã‚Œãªã«ï¼Ÿ']
            },
            {
                name: 'è’ã—ã‚³ãƒ¡ãƒ³ãƒˆ',
                icon: 'ğŸ˜ˆ',
                quote: 'ã¤ã¾ã‚“ã­ãƒ¼ãªã€ã‚‚ã£ã¨é¢ç™½ã„ã“ã¨ã‚„ã‚Œã‚ˆ',
                displayTime: 550,
                perfectThreshold: 370,
                totalGifts: 10,
                requiredSuccess: 3,
                requiredPerfect: 0,
                maxShots: 20,
                hasDecoy: false,
                randomPosition: false,
                comments: ['ã¤ã¾ã‚“ãª', 'ã‚‚ã†çµ‚ã‚ã‚Šï¼Ÿ', 'ä¸‹æ‰‹', 'ã‚»ãƒ³ã‚¹ãªã„ã­', 'ä»–ã®è¦‹ã‚‹ã‚', 'è¦‹ã©ã“ã‚ãªã„ã­', 'ã‚‚ã†å¸°ã‚‹ã‚', 'ã°ã„ã°ã„', 'æ™‚é–“ã®ç„¡é§„', 'ã‚„ã‚‹æ°—ãªã„ã ã‚']
            },
            {
                name: 'ã‚»ã‚¯ãƒãƒ©ã‚³ãƒ¡ãƒ³ãƒˆ',
                icon: 'ğŸ˜',
                quote: 'å¯æ„›ã™ãâ™¡ é´ä¸‹è¦‹ã›ã¦ï¼Ÿ',
                displayTime: 500,
                perfectThreshold: 370,
                totalGifts: 10,
                requiredSuccess: 3,
                requiredPerfect: 1,
                maxShots: 15,
                hasDecoy: false,
                randomPosition: false,
                comments: ['å¯æ„›ã™ã', 'å½¼æ°ã„ã‚‹ï¼Ÿ', 'ä¼šã„ãŸã„ãª', 'LINEæ•™ãˆã¦', 'ä¿ºã®ã“ã¨ã©ã†æ€ã†ï¼Ÿ', 'ã‚¿ã‚¤ãƒ—ã ã‚', 'å¥½ã¿ã™ãã‚‹', 'é€£çµ¡å…ˆã»ã—ã„', 'ãƒ‡ãƒ¼ãƒˆã—ãŸã„', 'ä»Šåº¦ä¼šãŠã†ã‚ˆ']
            },
            {
                name: 'è¿·æƒ‘è‡ªèªã‚Š',
                icon: 'ğŸ—£ï¸',
                quote: 'ä¿ºã•ãƒ¼ã€ä»Šæ—¥ã­ã€ãƒã‚¸ã§ã•ãƒ¼',
                displayTime: 500,
                perfectThreshold: 370,
                totalGifts: 10,
                requiredSuccess: 3,
                requiredPerfect: 2,
                maxShots: 15,
                hasDecoy: false,
                randomPosition: false,
                comments: ['ä¿ºã•ãƒ¼ã€ä»Šæ—¥ã­', 'èã„ã¦ã‚‹ï¼Ÿä¿ºã®è©±', 'è‡ªåˆ†ã®è©±ã—ã¦ã„ã„ï¼Ÿ', 'ä¿ºã‚‚é…ä¿¡ã—ã¦ã¦', 'ã¡ãªã¿ã«ä¿ºã¯', 'å®Ÿã¯ä¿ºã‚‚ã­', 'ä¿ºã®çµŒé¨“ã ã¨', 'ä¿ºã®å ´åˆã¯', 'ä¿ºãŒæ€ã†ã«', 'ä¿ºã‚‚åŒã˜çµŒé¨“ã‚ã£ã¦']
            },
            {
                name: 'åˆè¦‹ã§è‡ªåˆ†å®£ä¼',
                icon: 'ğŸ“¢',
                quote: 'ä¿ºã‚‚é…ä¿¡è€…ã§ã™ï¼ãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²ãŠé¡˜ã„ã—ã¾ã™ï¼',
                displayTime: 500,
                perfectThreshold: 370,
                totalGifts: 10,
                requiredSuccess: 4,
                requiredPerfect: 1,
                maxShots: 15,
                hasDecoy: false,
                randomPosition: true,
                comments: ['ä¿ºã‚‚é…ä¿¡è€…ã§ã™', 'ãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²ãŠé¡˜ã„', 'ä¿ºã®é…ä¿¡ã‚‚æ¥ã¦', 'ã‚³ãƒ©ãƒœã—ã¾ã›ã‚“ã‹', 'ç›¸äº’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¾ã—ã‚‡', 'ä¿ºã®å‹•ç”»è¦‹ã¦ã­', 'ãƒãƒ£ãƒ³ãƒãƒ«URLè²¼ã‚‹ã­', 'ç™»éŒ²è€…å¢—ã‚„ã—ãŸã„', 'å®£ä¼å¤±ç¤¼ã—ã¾ã™', 'ãƒ•ã‚©ãƒ­ãƒãŠé¡˜ã„ã—ã¾ã™']
            },
            {
                name: 'æŒ‡ç¤ºå¨',
                icon: 'ğŸ‘†',
                quote: 'ã€‡ã€‡ã‚„ã£ã¦ï¼ãªã‚“ã§ã‚„ã‚‰ãªã„ã®ï¼Ÿ',
                displayTime: 500,
                perfectThreshold: 370,
                totalGifts: 10,
                requiredSuccess: 4,
                requiredPerfect: 2,
                maxShots: 15,
                hasDecoy: false,
                randomPosition: true,
                comments: ['ã€‡ã€‡ã‚„ã£ã¦', 'æ¬¡ã“ã‚Œã‚„ã‚Œ', 'ãªã‚“ã§ã‚„ã‚‰ãªã„ã®', 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆèã„ã¦ã‚ˆ', 'ãã‚Œé•ã†ã‚ˆ', 'ã“ã†ã—ãŸæ–¹ãŒã„ã„', 'è¨€ã£ãŸé€šã‚Šã«ã‚„ã£ã¦', 'ãªã‚“ã§ã§ããªã„ã®', 'ä¸‹æ‰‹ã™ã', 'ã‚„ã‚Šæ–¹é–“é•ã£ã¦ã‚‹']
            },
            {
                name: 'è£DMé€£æ‰“',
                icon: 'ğŸ“±',
                quote: 'DMè¿”ä¿¡ã—ã¦ï¼æ—¢èª­ã¤ã„ã¦ã‚‹ã‚ˆã­ï¼Ÿ',
                displayTime: 500,
                perfectThreshold: 370,
                totalGifts: 10,
                requiredSuccess: 4,
                requiredPerfect: 0,
                maxShots: 12,
                hasDecoy: true,
                randomPosition: true,
                comments: ['DMè¿”ä¿¡ã—ã¦', 'ãªã‚“ã§ç„¡è¦–ã™ã‚‹ã®', 'æ—¢èª­ã¤ã„ã¦ã‚‹ã‚ˆã­', 'èª­ã‚“ã§ã‚‹ã§ã—ã‚‡', 'ã­ã‡è¦‹ã¦', 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦‹ãŸï¼Ÿ', 'è¿”äº‹ãã‚Œãªã„ã®', 'ç„¡è¦–ã—ãªã„ã§', 'é€£çµ¡å¾…ã£ã¦ã‚‹ã‚“ã ã‘ã©', 'ã¡ã‚ƒã‚“ã¨èª­ã‚“ã§ã­']
            },
            {
                name: 'è¡ŒãéããŸã‚¬ãƒæ‹',
                icon: 'ğŸ’•',
                quote: 'å¥½ãã§ã™ã€ä»˜ãåˆã£ã¦ãã ã•ã„ï¼',
                displayTime: 500,
                perfectThreshold: 370,
                totalGifts: 10,
                requiredSuccess: 4,
                requiredPerfect: 1,
                maxShots: 12,
                hasDecoy: true,
                randomPosition: true,
                comments: ['å¥½ãã§ã™ä»˜ãåˆã£ã¦', 'ä¿ºã ã‘è¦‹ã¦', 'ä»–ã®äººã¨è©±ã•ãªã„ã§', 'çµå©šã—ã‚ˆã†', 'é‹å‘½æ„Ÿã˜ã‚‹', 'å›ã¯ä¿ºã®ã‚‚ã®', 'ä¸€ç”Ÿä¸€ç·’ã«ã„ã‚ˆã†', 'ä»–ã®ãƒªã‚¹ãƒŠãƒ¼å«Œã„', 'ä¿ºã®ã“ã¨æ„›ã—ã¦ã‚‹ï¼Ÿ', 'å›ã—ã‹è¦‹ãˆãªã„']
            },
            {
                name: 'ç‰¹å®šå¨',
                icon: 'ğŸ”',
                quote: 'ã€‡ã€‡é§…ã ã‚ˆã­ï¼Ÿæœ¬åçŸ¥ã£ã¦ã‚‹ã‚ˆ',
                displayTime: 500,
                perfectThreshold: 370,
                totalGifts: 10,
                requiredSuccess: 4,
                requiredPerfect: 2,
                maxShots: 12,
                hasDecoy: true,
                randomPosition: true,
                comments: ['ã€‡ã€‡é§…ã ã‚ˆã­', 'å‰ã«è¦‹ãŸã“ã¨ã‚ã‚‹', 'æœ¬åçŸ¥ã£ã¦ã‚‹ã‚ˆ', 'å­¦æ ¡ã©ã“ï¼Ÿ', 'ä½ã‚“ã§ã‚‹å ´æ‰€ãƒãƒ¬ã¦ã‚‹', 'ã€‡ã€‡ã«ä½ã‚“ã§ã‚‹ã§ã—ã‚‡', 'ç‰¹å®šã§ããŸ', 'å®Ÿå®¶ã®ä½æ‰€ã‚ã‹ã£ãŸ', 'å®¶ã®è¿‘ãã§è¦‹ãŸã‚ˆ', 'è·å ´çŸ¥ã£ã¦ã‚‹']
            },
            {
                name: 'ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ³',
                icon: 'ğŸ¦„',
                quote: 'ç”·ã¨å–‹ã‚‹ãªï¼è£åˆ‡ã‚‰ã‚ŒãŸï¼',
                displayTime: 500,
                perfectThreshold: 370,
                totalGifts: 8,
                requiredSuccess: 5,
                requiredPerfect: 2,
                maxShots: 12,
                hasDecoy: true,
                randomPosition: true,
                comments: ['ç”·ã¨å–‹ã‚‹ãª', 'è£åˆ‡ã‚‰ã‚ŒãŸ', 'æ¸…æ¥šãªã®ãŒè‰¯ã‹ã£ãŸã®ã«', 'ã‚‚ã†è¦‹ãªã„', 'ãƒ•ã‚¡ãƒ³è¾ã‚ã¾ã™', 'æœŸå¾…ã—ã¦ãŸã®ã«', 'ç”·æ€§ææ€–ç—‡ã˜ã‚ƒãªã‹ã£ãŸã®ï¼Ÿ', 'ç”·ã®å½±ãƒãƒ©ã¤ã„ãŸ', 'ã‚¢ãƒ³ãƒã«ãªã‚‹', 'æ¨ã™ã®ã‚„ã‚ãŸ']
            },
            {
                name: 'ç„¡æ–­è»¢è¼‰',
                icon: 'ğŸ´â€â˜ ï¸',
                quote: 'ã“ã‚Œä¿å­˜ã—ãŸã€å‹æ‰‹ã«ä½¿ã†ã‚',
                displayTime: 500,
                perfectThreshold: 370,
                totalGifts: 8,
                requiredSuccess: 5,
                requiredPerfect: 2,
                maxShots: 10,
                hasDecoy: true,
                randomPosition: true,
                comments: ['ã“ã‚Œä¿å­˜ã—ãŸ', 'åˆ¥ã®ã‚µã‚¤ãƒˆã«ä¸Šã’ã‚‹ã­', 'å‹æ‰‹ã«ä½¿ã†ã‚', 'ã‚¹ã‚¯ã‚·ãƒ§æ’®ã£ãŸ', 'è»¢è¼‰ç¦æ­¢ã£ã¦æ›¸ã„ã¦ãªã„ã—', 'é´ä¸‹ã¾ã§è¦‹ã›ã¦æ¬²ã—ã„ã§ã™', 'ã‚¢ã‚¤ã‚³ãƒ³ã«ã™ã‚‹ã­', 'åˆ‡ã‚ŠæŠœãä½œã‚‹ã‚', 'ã“ã®ãã‚‰ã„ã„ã„ã˜ã‚ƒã‚“', 'ãŠé‡‘å–ã‚‹ã£ã¦ã“ã¨ï¼Ÿä¿ºå°å­¦ç”Ÿã ã‚ˆ']
            },
            {
                name: 'å¾¡æ°—æŒè¡¨æ˜ç²˜ç€åè»¢',
                icon: 'ğŸ˜¡',
                quote: 'ã„ã¤ã‚‚å¿œæ´ã—ã¦ã¾ã—ãŸã€ãªã®ã«è£åˆ‡ã‚‰ã‚ŒãŸã€‚',
                displayTime: 500,
                perfectThreshold: 370,
                totalGifts: 7,
                requiredSuccess: 5,
                requiredPerfect: 5,
                maxShots: 10,
                hasDecoy: true,
                randomPosition: true,
                comments: ['ã„ã¤ã‚‚å¿œæ´ã—ã¦ã¾ã—ãŸ', 'ãªã®ã«è£åˆ‡ã‚‰ã‚ŒãŸ', 'ä¿¡ã˜ã¦ãŸã®ã«', 'å¥½ãã ã£ãŸã®ã«å«Œã„ã«ãªã£ãŸ', 'è¨±ã•ãªã„', 'ã‚‚ã†äºŒåº¦ã¨è¦‹ãªã„', 'è£åˆ‡ã‚Šè€…', 'ãšã£ã¨æ¨ã—ã¦ãŸã®ã«', 'ä¿¡ç”¨ã—ã¦ãŸã®ã«æœ€ä½', 'çµ¶å¯¾è¨±ã•ãªã„ã‹ã‚‰ãª']
            },
            {
                name: 'äº¬é‡ãªã¡',
                icon: 'ğŸ»',
                quote: 'é–‹ç™ºè€…ã®æœ¬æ°—ã‚’è¦‹ã›ã¦ã‚„ã‚‹',
                displayTime: 400,
                perfectThreshold: 370,
                totalGifts: 5,
                requiredSuccess: 5,
                requiredPerfect: 5,
                maxShots: 6,
                hasDecoy: true,
                randomPosition: true,
                comments: ['ã´', 'æˆ‘ãŒåã¯äº¬é‡ï¼', 'ã¨æ€ã†ã˜ã‚ƒã‚“', 'ä»Šæœˆã®ã‚¯ãƒ¬ã‚«æ”¯æ‰•ã„ã‚„ã°ã„', 'å¥½ããªé£Ÿã¹ç‰©ã¯ã‚‚ã¤é‹', 'å¥½ããªé£²ã¿ç‰©ã¯çˆç²', 'åº§å³ã®éŠ˜ã¯ã€Œå› æœå¿œå ±ã€', 'è¡€æ¶²å‹ã¯ABå‹', 'ç´«æ—ã®è«–ç†å­¦è€…', 'æ¯æ—¥4ï½6æ™‚ã«æœæ´»é…ä¿¡ä¸­ï¼']
            },
            {
                name: 'ã€äººé¡åˆ°é”ç‚¹ã€‘ç‘ä¹ƒã—ã‚',
                icon: 'ğŸ¼',
                quote: 'ã—ãƒ¼ã¯ã‚ã ã‚ˆï¼',
                displayTime: 300,
                perfectThreshold: 250,
                totalGifts: 5,
                requiredSuccess: 5,
                requiredPerfect: 5,
                maxShots: 5,
                hasDecoy: true,
                decoyCount: 10,
                randomPosition: true,
                comments: ['ã–ããƒ¼ã“ã–ããƒ¼ã“', 'ã‚ˆã‚ã', 'ã†ã‚‹ã•ãã„', 'ãƒã‚«ã˜ã‚ƒãƒ¼ã‚“', 'ã†ã‘ã‚‹ãƒ¼', 'ã‚„ã°ã', 'æ¥å¾…ã‚‚ã§ããªã„ã®ï¼Ÿ', 'ãƒ¡ã‚¹ã‚¬ã‚­ï¼ˆ24ï¼‰', 'å¹³å’ŒãŒä¸€ç•ª', 'ãã‚“ãªã«ä¼šè©±è¡“çŸ¥ã£ã¦ã‚‹ã®ã«ãªã‚“ã§æ‹äººã§ããªã„ã®ï¼Ÿ']
            }
        ];

        let gameState = {
            selectedCharacter: localStorage.getItem('selectedCharacter') || null,
            selectedName: localStorage.getItem('selectedName') || null,
            currentStage: 0,
            successCount: 0,
            perfectCount: 0,
            remainingGifts: 10,
            realGiftShown: 0, // ã‚ãŸã‚Šã‚®ãƒ•ãƒˆãŒå‡ºç¾ã—ãŸå›æ•°
            shotCount: 0, // ä½¿ç”¨ã—ãŸã‚·ãƒ£ãƒƒã‚¿ãƒ¼æ•°
            maxShots: 20, // ã‚·ãƒ£ãƒƒã‚¿ãƒ¼åˆ¶é™
            giftActive: false,
            giftStartTime: 0,
            giftIsDecoy: false,
            gameRunning: false,
            clearedStages: JSON.parse(localStorage.getItem('clearedStages') || '[]'),
            unlockedStage: parseInt(localStorage.getItem('unlockedStage') || '0'),
            giftTimer: null,
            hideGiftTimer: null,
            giftPatterns: [],
            currentGiftIndex: 0
        };

        // æ¸¬å®šãƒ¢ãƒ¼ãƒ‰ç”¨ã®çŠ¶æ…‹
        let measurementState = {
            isRunning: false,
            currentCount: 0,
            maxCount: 5,
            results: [],
            giftTimer: null,
            hideGiftTimer: null,
            giftActive: false,
            giftStartTime: 0
        };

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function startGame() {
            if (!gameState.selectedCharacter) {
                showScreen('character-select-screen');
            } else {
                updateCurrentStreamerDisplay();
                renderStageList();
                showScreen('stage-select-screen');
            }
        }

        function selectCharacter(type, name) {
            gameState.selectedCharacter = type;
            gameState.selectedName = name;
            localStorage.setItem('selectedCharacter', type);
            localStorage.setItem('selectedName', name);
            
            updateCurrentStreamerDisplay();
            
            // åˆå›ã‚‚å«ã‚ã¦ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠç”»é¢ã¸
            renderStageList();
            showScreen('stage-select-screen');
        }

        function updateCurrentStreamerDisplay() {
            const avatar = document.getElementById('current-avatar');
            const nameEl = document.getElementById('current-name');
            
            avatar.className = 'streamer-avatar'; // ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            if (gameState.selectedCharacter === 'female') {
                avatar.classList.add('female');
            } else if (gameState.selectedCharacter === 'character3') {
                avatar.classList.add('character3');
            }
            
            let imgSrc;
            if (gameState.selectedCharacter === 'male') {
                imgSrc = 'images/character01_1.png';
            } else if (gameState.selectedCharacter === 'female') {
                imgSrc = 'images/character02_1.png';
            } else if (gameState.selectedCharacter === 'character3') {
                imgSrc = 'images/character03_1.png';
            }
            avatar.querySelector('img').src = imgSrc;
            nameEl.textContent = gameState.selectedName;
        }

        function renderStageList() {
            const stageList = document.getElementById('stage-list');
            stageList.innerHTML = '';
            
            BOSSES.forEach((boss, index) => {
                const stageItem = document.createElement('div');
                stageItem.className = 'stage-item';
                
                const isCleared = gameState.clearedStages.includes(index);
                const isUnlocked = index <= gameState.unlockedStage;
                
                if (isCleared) {
                    stageItem.classList.add('cleared');
                } else if (!isUnlocked) {
                    stageItem.classList.add('locked');
                }
                
                let conditionText = `${boss.totalGifts}å€‹ä¸­${boss.requiredSuccess}å€‹æˆåŠŸ`;
                if (boss.requiredPerfect > 0) {
                    conditionText += ` (PERFECT ${boss.requiredPerfect})`;
                }
                
                let statusText = '';
                if (isCleared) {
                    statusText = 'ã‚¯ãƒªã‚¢æ¸ˆã¿';
                } else if (isUnlocked) {
                    statusText = 'æŒ‘æˆ¦å¯èƒ½';
                } else {
                    statusText = 'æœªé–‹æ”¾';
                }
                
                stageItem.innerHTML = `
                    <div class="stage-icon">${boss.icon}</div>
                    <div class="stage-info">
                        <div class="stage-name">STAGE ${index + 1}: ${boss.name}</div>
                        <div class="stage-condition">${conditionText}</div>
                    </div>
                    <div class="stage-status">${statusText}</div>
                `;
                
                if (isUnlocked) {
                    stageItem.onclick = () => {
                        gameState.currentStage = index;
                        showStageConfirm();
                    };
                }
                
                stageList.appendChild(stageItem);
            });
        }

        function showStageConfirm() {
            const boss = BOSSES[gameState.currentStage];
            
            // åˆ¤å®šè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
            const judgment = document.getElementById('judgment');
            judgment.style.opacity = '0';
            judgment.className = '';
            
            // ãƒœã‚¹æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('confirm-boss-icon').textContent = boss.icon;
            document.getElementById('confirm-boss-name').textContent = boss.name;
            document.getElementById('confirm-boss-quote').textContent = `ã€Œ${boss.quote}ã€`;
            
            // é”æˆæ¡ä»¶ã‚’è¡¨ç¤º
            let conditionText = `${boss.totalGifts}å€‹ä¸­${boss.requiredSuccess}å€‹æˆåŠŸ`;
            if (boss.requiredPerfect > 0) {
                conditionText += `<br>(PERFECT ${boss.requiredPerfect}å›)`;
            }
            document.getElementById('confirm-condition-text').innerHTML = conditionText;
            
            // é›£æ˜“åº¦ã‚¿ã‚°ã‚’è¡¨ç¤º
            const difficultyDiv = document.getElementById('confirm-difficulty');
            difficultyDiv.innerHTML = '';
            
            // å‡ºç¾ä½ç½®ã‚¿ã‚°
            const positionTag = document.createElement('div');
            positionTag.className = 'difficulty-tag';
            positionTag.textContent = boss.randomPosition ? 'å‡ºç¾ä½ç½®ï¼šãƒ©ãƒ³ãƒ€ãƒ ' : 'å‡ºç¾ä½ç½®ï¼šå›ºå®š';
            difficultyDiv.appendChild(positionTag);
            
            // ãƒã‚ºãƒ¬ã‚®ãƒ•ãƒˆã‚¿ã‚°
            const decoyTag = document.createElement('div');
            decoyTag.className = 'difficulty-tag';
            decoyTag.textContent = boss.hasDecoy ? 'ãƒã‚ºãƒ¬ã‚®ãƒ•ãƒˆï¼šã‚ã‚Š' : 'ãƒã‚ºãƒ¬ã‚®ãƒ•ãƒˆï¼šãªã—';
            difficultyDiv.appendChild(decoyTag);
            
            showScreen('stage-confirm-screen');
        }

        function backToStageSelectFromConfirm() {
            renderStageList();
            showScreen('stage-select-screen');
        }

        function startGameFromConfirm() {
            // ã‚®ãƒ•ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç”Ÿæˆ
            generateGiftPatterns();
            
            // ã‚²ãƒ¼ãƒ ç”»é¢ã¸ç§»è¡Œ
            showScreen('game-screen');
            startStage();
        }

        function generateGiftPatterns() {
            const boss = BOSSES[gameState.currentStage];
            gameState.giftPatterns = [];
            
            console.log('Generating gift patterns for stage', gameState.currentStage + 1);
            
            // 1. ã‚ãŸã‚Šã‚®ãƒ•ãƒˆã‚’10å€‹ç”Ÿæˆ
            for (let i = 0; i < boss.totalGifts; i++) {
                const pattern = {
                    delay: i === 0 ? 3000 : (2000 + Math.random() * 2000),
                    isDecoy: false, // ã‚ãŸã‚Šã‚®ãƒ•ãƒˆ
                    position: boss.randomPosition ? {
                        x: 30 + Math.random() * 40,
                        y: 25 + Math.random() * 30
                    } : { x: 50, y: 40 }
                };
                gameState.giftPatterns.push(pattern);
            }
            
            // 2. ãƒã‚ºãƒ¬ã‚®ãƒ•ãƒˆã‚’è¿½åŠ 
            if (boss.hasDecoy) {
                const decoyCount = boss.decoyCount || (3 + Math.floor(Math.random() * 3)); // æŒ‡å®šãŒãªã‘ã‚Œã°3-5å€‹
                console.log('Adding', decoyCount, 'decoy gifts');
                for (let i = 0; i < decoyCount; i++) {
                    const pattern = {
                        delay: 2000 + Math.random() * 2000,
                        isDecoy: true, // ãƒã‚ºãƒ¬ã‚®ãƒ•ãƒˆ
                        position: boss.randomPosition ? {
                            x: 30 + Math.random() * 40,
                            y: 25 + Math.random() * 30
                        } : { x: 50, y: 40 }
                    };
                    gameState.giftPatterns.push(pattern);
                }
            }
            
            // 3. ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆæœ€åˆã®ã‚®ãƒ•ãƒˆã‚’é™¤ãï¼‰
            const firstGift = gameState.giftPatterns[0];
            const restGifts = gameState.giftPatterns.slice(1);
            
            // Fisher-Yatesã‚·ãƒ£ãƒƒãƒ•ãƒ«
            for (let i = restGifts.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [restGifts[i], restGifts[j]] = [restGifts[j], restGifts[i]];
            }
            
            gameState.giftPatterns = [firstGift, ...restGifts];
            gameState.currentGiftIndex = 0;
            
            const realCount = gameState.giftPatterns.filter(p => !p.isDecoy).length;
            const decoyCountActual = gameState.giftPatterns.filter(p => p.isDecoy).length;
            console.log('Generated patterns:', gameState.giftPatterns.length, 'total (', realCount, 'real +', decoyCountActual, 'decoy)');
        }

        function startStage() {
            const boss = BOSSES[gameState.currentStage];
            
            // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            if (gameState.giftTimer) {
                clearTimeout(gameState.giftTimer);
                gameState.giftTimer = null;
            }
            if (gameState.hideGiftTimer) {
                clearTimeout(gameState.hideGiftTimer);
                gameState.hideGiftTimer = null;
            }
            
            gameState.successCount = 0;
            gameState.perfectCount = 0;
            gameState.remainingGifts = boss.totalGifts;
            gameState.realGiftShown = 0;
            gameState.shotCount = 0;
            gameState.maxShots = boss.maxShots;
            gameState.giftActive = false;
            gameState.gameRunning = true;
            
            document.getElementById('boss-icon').textContent = boss.icon;
            document.getElementById('boss-name').textContent = boss.name;
            document.getElementById('stage-number').textContent = `STAGE ${gameState.currentStage + 1}/14`;
            
            let conditionText = `${boss.totalGifts}å€‹ä¸­${boss.requiredSuccess}å€‹æˆåŠŸ`;
            if (boss.requiredPerfect > 0) {
                conditionText += ` | PERFECT ${boss.requiredPerfect}å›`;
            }
            document.getElementById('boss-condition').textContent = conditionText;
            
            const streamer = document.getElementById('streamer');
            streamer.className = ''; // ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            if (gameState.selectedCharacter === 'female') {
                streamer.classList.add('female');
            } else if (gameState.selectedCharacter === 'character3') {
                streamer.classList.add('character3');
            }
            
            initRemainingGifts();
            updateScoreDisplay();
            updateFace();
            
            // åˆ¤å®šè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
            const judgment = document.getElementById('judgment');
            judgment.style.opacity = '0';
            judgment.className = '';
            
            startCommentFlow();
            scheduleNextGift();
        }

        function updateScoreDisplay() {
            const boss = BOSSES[gameState.currentStage];
            document.getElementById('success-count').textContent = 
                `${gameState.successCount}/${boss.requiredSuccess}`;
            document.getElementById('perfect-count').textContent = 
                `PERFECT: ${gameState.perfectCount}`;
            const remaining = gameState.maxShots - gameState.shotCount;
            document.getElementById('shot-count').textContent = `${remaining}å›`;
            updateRemainingGifts();
        }

        function updateRemainingGifts() {
            const icons = document.querySelectorAll('.gift-icon');
            const shownCount = gameState.realGiftShown; // ã‚ãŸã‚Šã‚®ãƒ•ãƒˆå‡ºç¾æ•°ã§æ¸›ã‚‰ã™
            
            icons.forEach((icon, index) => {
                if (index < shownCount) {
                    icon.classList.add('used');
                } else {
                    icon.classList.remove('used');
                }
            });
        }

        function initRemainingGifts() {
            const boss = BOSSES[gameState.currentStage];
            const container = document.getElementById('remaining-gifts-icons');
            container.innerHTML = '';
            
            // 10å€‹ï¼ˆtotalGiftsï¼‰è¡¨ç¤º
            for (let i = 0; i < boss.totalGifts; i++) {
                const icon = document.createElement('div');
                icon.className = 'gift-icon';
                icon.textContent = 'ğŸ';
                container.appendChild(icon);
            }
        }

        function updateFace() {
            const boss = BOSSES[gameState.currentStage];
            const streamerImg = document.getElementById('streamer-image');
            
            const neededSuccess = boss.requiredSuccess - gameState.successCount;
            const neededPerfect = Math.max(0, boss.requiredPerfect - gameState.perfectCount);
            
            // æ®‹ã‚Šã®ã‚ãŸã‚Šã‚®ãƒ•ãƒˆæ•°ã‚’è¨ˆç®—
            const totalRealGifts = gameState.giftPatterns.filter(p => !p.isDecoy).length;
            const remainingRealGifts = totalRealGifts - gameState.realGiftShown;
            
            let charPrefix;
            if (gameState.selectedCharacter === 'male') {
                charPrefix = 'character01';
            } else if (gameState.selectedCharacter === 'female') {
                charPrefix = 'character02';
            } else if (gameState.selectedCharacter === 'character3') {
                charPrefix = 'character03';
            }
            
            // å¾—æ„é¡”ï¼šã‚¯ãƒªã‚¢é”æˆ OR ã‚ã¨1å›æˆåŠŸã™ã‚Œã°ã‚¯ãƒªã‚¢
            if ((gameState.successCount >= boss.requiredSuccess && 
                 gameState.perfectCount >= boss.requiredPerfect) ||
                (neededSuccess === 1 && neededPerfect === 0)) {
                streamerImg.src = `images/${charPrefix}_3.png`;
            }
            // å›°ã‚Šé¡”ï¼šã‚‚ã†å¤±æ•—ã§ããªã„ï¼ˆã‚®ãƒªã‚®ãƒªï¼‰
            else if (remainingRealGifts === neededSuccess || 
                     (neededPerfect > 0 && remainingRealGifts === neededPerfect)) {
                streamerImg.src = `images/${charPrefix}_2.png`;
            }
            // é€šå¸¸é¡”ï¼šã¾ã ä½™è£•ãŒã‚ã‚‹
            else {
                streamerImg.src = `images/${charPrefix}_1.png`;
            }
        }

        function scheduleNextGift() {
            if (!gameState.gameRunning) {
                console.log('Game not running, cannot schedule gift');
                return;
            }
            
            // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            if (gameState.giftTimer) {
                clearTimeout(gameState.giftTimer);
                gameState.giftTimer = null;
            }
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ®‹ã£ã¦ã„ãªã„å ´åˆã¯çµ‚äº†
            if (gameState.currentGiftIndex >= gameState.giftPatterns.length) {
                console.log('No more gift patterns');
                return;
            }
            
            const pattern = gameState.giftPatterns[gameState.currentGiftIndex];
            gameState.currentGiftIndex++;
            
            console.log('Scheduling next gift in', pattern.delay, 'ms. Pattern index:', gameState.currentGiftIndex - 1);
            
            gameState.giftTimer = setTimeout(() => {
                showGift();
            }, pattern.delay);
        }

        function showGift() {
            if (!gameState.gameRunning) {
                console.log('Game not running, cannot show gift');
                return;
            }
            
            const boss = BOSSES[gameState.currentStage];
            const pattern = gameState.giftPatterns[gameState.currentGiftIndex - 1];
            
            if (!pattern) {
                console.log('No pattern found for index:', gameState.currentGiftIndex - 1);
                return;
            }
            
            console.log('Showing gift:', pattern);
            
            gameState.giftActive = true;
            gameState.giftStartTime = Date.now();
            gameState.giftIsDecoy = pattern.isDecoy;
            
            // ã‚ãŸã‚Šã‚®ãƒ•ãƒˆãŒå‡ºç¾ã—ãŸã‚‰ã‚«ã‚¦ãƒ³ãƒˆã—ã¦è¡¨ç¤ºæ›´æ–°
            if (!pattern.isDecoy) {
                gameState.realGiftShown++;
                updateRemainingGifts();
                console.log('Real gift shown, count:', gameState.realGiftShown);
            } else {
                console.log('Decoy gift shown, not counting');
            }
            
            const gift = document.getElementById('gift');
            const giftImg = gift.querySelector('img');
            
            // ç”»åƒåˆ‡ã‚Šæ›¿ãˆ
            if (gameState.giftIsDecoy) {
                giftImg.src = 'images/hazuregift01.png';
                console.log('Showing decoy gift');
            } else {
                giftImg.src = 'images/gift01.png';
                console.log('Showing real gift');
            }
            
            // ä½ç½®è¨­å®š
            gift.style.left = pattern.position.x + '%';
            gift.style.top = pattern.position.y + '%';
            
            gift.style.opacity = '1';
            gift.classList.add('gift-active');
            
            console.log('Gift displayed at:', pattern.position);
            
            // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            if (gameState.hideGiftTimer) {
                clearTimeout(gameState.hideGiftTimer);
            }
            
            // è¡¨ç¤ºæ™‚é–“å¾Œã«è‡ªå‹•ã§æ¶ˆãˆã‚‹
            gameState.hideGiftTimer = setTimeout(() => {
                if (gameState.giftActive) {
                    console.log('Gift auto-hide after', boss.displayTime, 'ms');
                    gameState.giftActive = false;
                    gift.style.opacity = '0';
                    gift.classList.remove('gift-active');
                    
                    scheduleNextGift();
                }
            }, boss.displayTime);
        }

        function takeShot() {
            console.log('=== takeShot CALLED ===');
            
            if (!gameState.gameRunning) {
                console.log('Game not running');
                return;
            }
            
            // ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ã‚«ã‚¦ãƒ³ãƒˆå¢—åŠ 
            gameState.shotCount++;
            updateScoreDisplay();
            
            // ã‚·ãƒ£ãƒƒã‚¿ãƒ¼åˆ¶é™ãƒã‚§ãƒƒã‚¯
            if (gameState.shotCount >= gameState.maxShots) {
                console.log('Out of shots - Game Over');
                showJudgment('MISS');
                updateFace();
                setTimeout(() => {
                    gameOver();
                }, 500);
                return;
            }
            
            console.log('Shot taken! Gift active:', gameState.giftActive);
            
            // ã‚®ãƒ•ãƒˆãŒãªã„æ™‚ã¯MISS
            if (!gameState.giftActive) {
                console.log('No gift active - MISS');
                showJudgment('MISS');
                updateFace();
                return; // ã‚®ãƒ•ãƒˆãŒãªã„æ™‚ã¯ä½•ã‚‚ã‚«ã‚¦ãƒ³ãƒˆã—ãªã„
            }
            
            const boss = BOSSES[gameState.currentStage];
            const currentTime = Date.now();
            const elapsedTime = currentTime - gameState.giftStartTime;
            
            console.log('Elapsed time:', elapsedTime, 'ms');
            
            // ã‚®ãƒ•ãƒˆã‚’å³åº§ã«éã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
            gameState.giftActive = false;
            
            // ã‚®ãƒ•ãƒˆã‚’æ¶ˆã™ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            if (gameState.hideGiftTimer) {
                clearTimeout(gameState.hideGiftTimer);
                gameState.hideGiftTimer = null;
            }
            
            const gift = document.getElementById('gift');
            gift.style.opacity = '0';
            gift.classList.remove('gift-active');
            
            // ãƒã‚ºãƒ¬ã‚®ãƒ•ãƒˆã‚’æ’®å½±ã—ãŸå ´åˆ
            if (gameState.giftIsDecoy) {
                console.log('Decoy gift!');
                showJudgment('ãƒã‚ºãƒ¬ï¼');
                updateFace();
                checkGameResult();
                return;
            }
            
            // åˆ¤å®š: PERFECTåˆ¤å®šã¯ã‚¹ãƒ†ãƒ¼ã‚¸ã”ã¨ã«å¯å¤‰
            const perfectThreshold = boss.perfectThreshold || 370; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ370ms
            
            let judgment = '';
            if (elapsedTime <= perfectThreshold) {
                judgment = 'PERFECT';
                gameState.successCount++;
                gameState.perfectCount++;
            } else if (elapsedTime <= boss.displayTime) {
                judgment = 'NICE';
                gameState.successCount++;
            } else {
                judgment = 'MISS';
            }
            
            console.log('Judgment:', judgment);
            
            showJudgment(judgment);
            updateScoreDisplay();
            updateFace();
            
            checkGameResult();
        }

        function showJudgment(type) {
            const judgment = document.getElementById('judgment');
            const judgmentImg = document.getElementById('judgment-img');
            const judgmentText = document.getElementById('judgment-text');
            
            // ã‚¯ãƒ©ã‚¹åã‚’è¨­å®š
            let className = 'judgment-';
            
            if (type === 'ãƒã‚ºãƒ¬ï¼') {
                className += 'hazure';
                judgmentText.textContent = 'ãƒã‚ºãƒ¬ï¼';
            } else if (type === 'MISS') {
                className += 'miss';
                judgmentText.textContent = 'MISS';
            } else if (type === 'PERFECT') {
                className += 'perfect';
                judgmentImg.src = 'images/hantei_perfect.png';
            } else if (type === 'NICE') {
                className += 'good';
                judgmentImg.src = 'images/hantei_good.png';
            }
            
            judgment.className = className;
            judgment.style.opacity = '1';
            
            setTimeout(() => {
                judgment.style.opacity = '0';
            }, 1000);
        }

        function checkGameResult() {
            const boss = BOSSES[gameState.currentStage];
            
            // ã‚¯ãƒªã‚¢æ¡ä»¶ãƒã‚§ãƒƒã‚¯
            if (gameState.successCount >= boss.requiredSuccess && 
                gameState.perfectCount >= boss.requiredPerfect) {
                stageClear();
                return;
            }
            
            // ã‚¯ãƒªã‚¢ä¸å¯èƒ½åˆ¤å®š
            const neededSuccess = boss.requiredSuccess - gameState.successCount;
            const neededPerfect = boss.requiredPerfect - gameState.perfectCount;
            
            // æ®‹ã‚Šã‚ãŸã‚Šã‚®ãƒ•ãƒˆæ•°ã‚’è¨ˆç®—
            const totalRealGifts = gameState.giftPatterns.filter(p => !p.isDecoy).length;
            const remainingRealGifts = totalRealGifts - gameState.realGiftShown;
            
            console.log('Check result: need', neededSuccess, 'success,', neededPerfect, 'perfect. Remaining real gifts:', remainingRealGifts);
            
            if (remainingRealGifts < neededSuccess || 
                remainingRealGifts < neededPerfect) {
                console.log('Game over: not enough real gifts remaining');
                gameOver();
                return;
            }
            
            // å…¨ã‚®ãƒ•ãƒˆå‡ºç¾æ¸ˆã¿ã‹ã¤æœªã‚¯ãƒªã‚¢
            if (gameState.currentGiftIndex >= gameState.giftPatterns.length) {
                console.log('Game over: all gifts shown');
                gameOver();
                return;
            }
            
            // ã¾ã ç¶šè¡Œå¯èƒ½
            scheduleNextGift();
        }

        function startCommentFlow() {
            const boss = BOSSES[gameState.currentStage];
            const comments = boss.comments;
            
            function addComment() {
                if (!gameState.gameRunning) return;
                
                const commentText = comments[Math.floor(Math.random() * comments.length)];
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment';
                commentDiv.textContent = commentText;
                
                const commentsContainer = document.getElementById('comments');
                commentsContainer.appendChild(commentDiv);
                
                while (commentsContainer.children.length > 5) {
                    commentsContainer.removeChild(commentsContainer.firstChild);
                }
                
                const delay = Math.random() * 1500 + 800;
                setTimeout(addComment, delay);
            }
            
            addComment();
        }

        function stageClear() {
            gameState.gameRunning = false;
            
            // ã™ã¹ã¦ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            if (gameState.giftTimer) {
                clearTimeout(gameState.giftTimer);
                gameState.giftTimer = null;
            }
            if (gameState.hideGiftTimer) {
                clearTimeout(gameState.hideGiftTimer);
                gameState.hideGiftTimer = null;
            }
            
            // åˆ¤å®šè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
            const judgment = document.getElementById('judgment');
            judgment.style.opacity = '0';
            judgment.className = '';
            
            if (!gameState.clearedStages.includes(gameState.currentStage)) {
                gameState.clearedStages.push(gameState.currentStage);
                localStorage.setItem('clearedStages', JSON.stringify(gameState.clearedStages));
            }
            
            if (gameState.currentStage >= gameState.unlockedStage) {
                gameState.unlockedStage = gameState.currentStage + 1;
                localStorage.setItem('unlockedStage', gameState.unlockedStage.toString());
            }
            
            document.getElementById('clear-overlay').style.display = 'flex';
        }

        function gameOver() {
            gameState.gameRunning = false;
            
            // ã™ã¹ã¦ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            if (gameState.giftTimer) {
                clearTimeout(gameState.giftTimer);
                gameState.giftTimer = null;
            }
            if (gameState.hideGiftTimer) {
                clearTimeout(gameState.hideGiftTimer);
                gameState.hideGiftTimer = null;
            }
            
            // åˆ¤å®šè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
            const judgment = document.getElementById('judgment');
            judgment.style.opacity = '0';
            judgment.className = '';
            
            document.getElementById('gameover-overlay').style.display = 'flex';
        }

        function retryStage() {
            document.getElementById('gameover-overlay').style.display = 'none';
            generateGiftPatterns(); // ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å†ç”Ÿæˆ
            startStage();
        }

        function nextStage() {
            document.getElementById('clear-overlay').style.display = 'none';
            gameState.currentStage++;
            
            if (gameState.currentStage >= BOSSES.length) {
                showScreen('game-complete');
            } else {
                showStageConfirm(); // ç¢ºèªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’è¡¨ç¤º
            }
        }

        function backToStageSelect() {
            document.getElementById('clear-overlay').style.display = 'none';
            document.getElementById('gameover-overlay').style.display = 'none';
            renderStageList();
            showScreen('stage-select-screen');
        }

        function quitGame() {
            // ã‚²ãƒ¼ãƒ ã‚’åœæ­¢
            gameState.gameRunning = false;
            
            // ã™ã¹ã¦ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            if (gameState.giftTimer) {
                clearTimeout(gameState.giftTimer);
                gameState.giftTimer = null;
            }
            if (gameState.hideGiftTimer) {
                clearTimeout(gameState.hideGiftTimer);
                gameState.hideGiftTimer = null;
            }
            
            // åˆ¤å®šè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
            const judgment = document.getElementById('judgment');
            judgment.style.opacity = '0';
            judgment.className = '';
            
            // ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠç”»é¢ã«æˆ»ã‚‹
            renderStageList();
            showScreen('stage-select-screen');
        }

        // åˆå›è¨ªå•ãƒã‚§ãƒƒã‚¯
        function checkFirstVisit() {
            const hasVisited = localStorage.getItem('hasVisitedGiftmanChallenge');
            
            if (!hasVisited) {
                // åˆå›è¨ªå•ã®å ´åˆã€éŠã³æ–¹ã‚’è¡¨ç¤º
                localStorage.setItem('hasVisitedGiftmanChallenge', 'true');
                showScreen('howto-screen');
            }
        }

        // ===== æ¸¬å®šãƒ¢ãƒ¼ãƒ‰é–¢æ•° =====
        function startMeasurementMode() {
            measurementState.isRunning = true;
            measurementState.currentCount = 0;
            measurementState.results = [];
            
            // ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºã‚’æ›´æ–°
            document.getElementById('measurement-count').textContent = '0/5';
            
            // é…ä¿¡è€…ç”»åƒã‚’è¨­å®š
            const streamerImg = document.getElementById('measurement-streamer-img');
            if (gameState.selectedCharacter) {
                if (gameState.selectedCharacter === 'male') {
                    streamerImg.src = 'images/character01_1.png';
                } else if (gameState.selectedCharacter === 'female') {
                    streamerImg.src = 'images/character02_1.png';
                } else if (gameState.selectedCharacter === 'character3') {
                    streamerImg.src = 'images/character03_1.png';
                }
            }
            
            // ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã«5è¡Œã®åˆæœŸè¡¨ç¤ºã‚’ä½œæˆ
            const commentsDiv = document.getElementById('measurement-comments');
            commentsDiv.innerHTML = '';
            for (let i = 1; i <= 5; i++) {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment';
                commentDiv.id = `measurement-result-${i}`;
                commentDiv.textContent = `${i}å›ç›®: ---`;
                commentDiv.style.opacity = '1';
                commentDiv.style.transform = 'translateY(0)';
                commentsDiv.appendChild(commentDiv);
            }
            
            // ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            const shutterBtn = document.getElementById('measurement-shutter-button');
            shutterBtn.onclick = takeMeasurementShot;
            
            showScreen('measurement-screen');
            
            // æœ€åˆã®ã‚®ãƒ•ãƒˆã‚’3ç§’å¾Œã«è¡¨ç¤º
            setTimeout(() => {
                showMeasurementGift();
            }, 3000);
        }

        function showMeasurementGift() {
            if (!measurementState.isRunning) return;
            
            measurementState.giftActive = true;
            measurementState.giftStartTime = Date.now();
            
            const gift = document.getElementById('measurement-gift');
            
            // ãƒ©ãƒ³ãƒ€ãƒ ä½ç½®
            const x = 30 + Math.random() * 40;
            const y = 25 + Math.random() * 30;
            gift.style.left = x + '%';
            gift.style.top = y + '%';
            gift.style.opacity = '1';
            gift.classList.add('gift-active');
            
            console.log('Measurement gift displayed at:', {x, y});
            
            // 500mså¾Œã«è‡ªå‹•ã§æ¶ˆãˆã‚‹
            measurementState.hideGiftTimer = setTimeout(() => {
                gift.style.opacity = '0';
                gift.classList.remove('gift-active');
                measurementState.giftActive = false;
                
                // æ¬¡ã®ã‚®ãƒ•ãƒˆã‚’è¡¨ç¤ºï¼ˆã¾ã 5å›æœªæº€ãªã‚‰ï¼‰
                if (measurementState.currentCount < measurementState.maxCount) {
                    setTimeout(() => {
                        showMeasurementGift();
                    }, 2000 + Math.random() * 2000);
                }
            }, 500);
        }

        function takeMeasurementShot() {
            console.log('=== takeMeasurementShot CALLED ===');
            
            if (!measurementState.isRunning) {
                console.log('Measurement not running');
                return;
            }
            
            if (!measurementState.giftActive) {
                console.log('No gift active in measurement');
                return;
            }
            
            const currentTime = Date.now();
            const elapsedTime = currentTime - measurementState.giftStartTime;
            
            console.log('Measurement elapsed time:', elapsedTime, 'ms');
            
            // ã‚®ãƒ•ãƒˆã‚’å³åº§ã«éã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
            measurementState.giftActive = false;
            
            // ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            if (measurementState.hideGiftTimer) {
                clearTimeout(measurementState.hideGiftTimer);
                measurementState.hideGiftTimer = null;
            }
            
            const gift = document.getElementById('measurement-gift');
            gift.style.opacity = '0';
            gift.classList.remove('gift-active');
            
            // åˆ¤å®šã‚’è¡¨ç¤º
            let judgment = '';
            if (elapsedTime <= 370) {
                judgment = 'PERFECT';
            } else if (elapsedTime <= 500) {
                judgment = 'NICE';
            } else {
                judgment = 'MISS';
            }
            showMeasurementJudgment(judgment);
            
            // çµæœã‚’è¨˜éŒ²
            measurementState.currentCount++;
            measurementState.results.push(elapsedTime);
            
            // ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºã‚’æ›´æ–°
            document.getElementById('measurement-count').textContent = 
                `${measurementState.currentCount}/5`;
            
            // è©²å½“ã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã‚’æ›´æ–°
            const resultDiv = document.getElementById(`measurement-result-${measurementState.currentCount}`);
            if (resultDiv) {
                resultDiv.textContent = `${measurementState.currentCount}å›ç›®: ${elapsedTime}ms`;
            }
            
            // 5å›çµ‚ã‚ã£ãŸã‚‰çµæœç”»é¢ã¸
            if (measurementState.currentCount >= measurementState.maxCount) {
                setTimeout(() => {
                    showMeasurementResults();
                }, 1000);
            } else {
                // æ¬¡ã®ã‚®ãƒ•ãƒˆã‚’è¡¨ç¤º
                setTimeout(() => {
                    showMeasurementGift();
                }, 2000 + Math.random() * 2000);
            }
        }

        function showMeasurementJudgment(type) {
            const judgment = document.getElementById('measurement-judgment');
            const judgmentImg = document.getElementById('measurement-judgment-img');
            const judgmentText = document.getElementById('measurement-judgment-text');
            
            // ã‚¯ãƒ©ã‚¹åã‚’è¨­å®š
            let className = 'judgment-';
            
            if (type === 'MISS') {
                className += 'miss';
                judgmentText.textContent = 'MISS';
            } else if (type === 'PERFECT') {
                className += 'perfect';
                judgmentImg.src = 'images/hantei_perfect.png';
            } else if (type === 'NICE') {
                className += 'good';
                judgmentImg.src = 'images/hantei_good.png';
            }
            
            judgment.className = className;
            judgment.style.opacity = '1';
            
            setTimeout(() => {
                judgment.style.opacity = '0';
            }, 1000);
        }

        function showMeasurementResults() {
            measurementState.isRunning = false;
            
            // çµæœã‚’é›†è¨ˆ
            const average = Math.round(measurementState.results.reduce((a, b) => a + b, 0) / measurementState.results.length);
            const fastest = Math.min(...measurementState.results);
            
            const resultsDiv = document.getElementById('measurement-results-list');
            resultsDiv.innerHTML = `
                <div style="margin-bottom: 20px; color: #000;">
                    ${measurementState.results.map((time, index) => {
                        return `<div style="margin: 8px 0; color: #000;">${index + 1}å›ç›®: ${time}ms</div>`;
                    }).join('')}
                </div>
                <div style="border-top: 1px solid #666; padding-top: 15px; margin-top: 15px; color: #000;">
                    <div style="margin: 8px 0;">å¹³å‡: ${average}ms</div>
                    <div style="margin: 8px 0;">æœ€é€Ÿ: ${fastest}ms</div>
                </div>
            `;
            
            showScreen('measurement-result-screen');
        }

        function restartMeasurement() {
            startMeasurementMode();
        }

        function quitMeasurement() {
            measurementState.isRunning = false;
            
            if (measurementState.giftTimer) {
                clearTimeout(measurementState.giftTimer);
                measurementState.giftTimer = null;
            }
            if (measurementState.hideGiftTimer) {
                clearTimeout(measurementState.hideGiftTimer);
                measurementState.hideGiftTimer = null;
            }
            
            const gift = document.getElementById('measurement-gift');
            gift.style.opacity = '0';
            gift.classList.remove('gift-active');
            
            showScreen('portal-screen');
        }

        // ===== ã“ã“ã¾ã§æ¸¬å®šãƒ¢ãƒ¼ãƒ‰é–¢æ•° =====

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆå›ãƒã‚§ãƒƒã‚¯
        window.addEventListener('DOMContentLoaded', () => {
            checkFirstVisit();
        });
    </script>
</body>
</html>